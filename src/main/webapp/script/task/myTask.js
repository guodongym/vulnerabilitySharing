/**
 * Created by kingsir on 16/8/5.
 */

window.operateEvents = {
    //提交任务成果按钮点击事件
    'click .submit': function (e, value, row, index) {
        $("#taskId").val(row.taskId);
        $("#submitTaskModal").modal("show");
    },
    //转移队长按钮
    'click .trans': function (e, value, row, index) {
        transCaption(row.taskId);
    },
    //发布任务按钮
    'click .release': function (e, value, row, index) {
    	//发布任务确认
    	swal({
    		title:"发布",
    		text: "您确定要发布么?",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/release', {taskId : row.taskId}, function(data) {
    			if(!data.error){
                    swal({
                        title:"提示",
                        text: "发布成功",
                        type: "info",
                        showCancelButton: false,
                        confirmButtonText: "确定",
                        closeOnConfirm: true
                    },function(){
                        window.location.href = CTX+"/toTaskList";
                    })
    			}else{
    				swal(data.message);
    			}
    		});
    		
    	})
	
    },
    //修改任务按钮
    'click .update': function (e, value, row, index) {
        window.location.href = CTX+"/task/update?taskId="+row.taskId;
    },
    //确认任务完成按钮
    'click .complete': function (e, value, row, index) {
    	$.post(CTX+'/task/complete', {taskId : row.taskId}, function(data) {
    		if(!data.error){
    			swal("确认成功");
    			$("#releaseTable").bootstrapTable("refresh");
    		}else{
    			swal(data.message);
    		}
    	});
    },
    //取消任务按钮
    'click .cancel': function (e, value, row, index) {
    	$.post(CTX+'/task/cancel', {taskId : row.taskId}, function(data) {
    		if(!data.error){
    			swal("取消成功");
    			$("#releaseTable").bootstrapTable("refresh");
    		}else{
    			swal(data.message);
    		}
    	});
    },
    //删除任务按钮
    'click .delete': function (e, value, row, index) {
    	swal({
    		title:"删除",
    		text: "您确定要删除么?",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/delete', {taskId : row.taskId}, function(data) {
        		if(!data.error){
        			swal("删除成功");
        			$("#noReleaseTable").bootstrapTable("refresh");
        		}else{
        			swal(data.message);
        		}
        	});
    	});
    }
};

$(document).ready(function(){

	var conf={
		method: 'post',
	    contentType: "application/x-www-form-urlencoded",
		pagination: true,
	    pageList:[5, 10, 15, 20, 25],//可以选择一页显示 几行
		pageSize:5,//默认一页显示 几行
		pageNumber:1,//默认显示第几页
		sidePagination:'server',//设置为服务器端分页
		search: true,
		cache: false,
		showRefresh: true,//刷新按钮
		striped: true,//是否循环变色
	    paginationPreText:"前一页",
	    paginationNextText:"后一页",
	    showToggle:true
    };
    var acceptTable=conf;
    acceptTable.url = CTX+"/task/findReceivingPage";
    acceptTable.columns=[{
            field:"releaseTime",
            title:"发布时间",
            width:"15%"
        },{
            field:"taskName",
            title:"任务标题",
            width:"50%",
            formatter:function(value,row,index) {
            	return '<a href="'+CTX+'/task/taskDetail?taskId='+row.taskId+'">'+row.taskName+'</a>';
            }
        },{
            field:"leaderUserAccount",
            title:"队长",
            width:"10%",
            align:"center"
        },{
            field:"taskStatus",
            title:"任务状态",
            width:"10%",
            align:"center"
        },{
            field:"handdle",
            title:"操作",
            width:"15%",
            align:"center",
            formatter:function(value,row,index){
                var submit="";
                var trans="";
                if(row.submit){
                    submit='<a class="submit" href="javascript:void(0)" title="提交成果"><i class="glyphicon glyphicon-hand-up"></i></a>';
                }else{
                	submit='<span href="javascript:void(0)" title="提交成果"><i class="glyphicon glyphicon-hand-up"></i></span>';
                }
                if(row.leader){
                    trans='<a class="trans" href="javascript:void(0)" title="转移队长"><i class="glyphicon glyphicon-send"></i></a>';
                }else{
                    trans='<span href="javascript:void(0)" title="转移队长"><i class="glyphicon glyphicon-send"></i></s>';
                }
                return submit+trans;
            },
            events:'operateEvents'
        }];
    $("#myAcceptTable").bootstrapTable(acceptTable);
    
    

    var noReleaseTable=conf;
    noReleaseTable.url = CTX+"/task/findNotReleasePage";
    noReleaseTable.columns=[{
        field:"releaseTime",
        title:"发布时间",
        width:"15%"
    },{
        field:"taskName",
        title:"任务标题",
        width:"60%",
        formatter:function(value,row,index) {
        	return '<a href="'+CTX+'/task/taskDetail?taskId='+row.taskId+'">'+row.taskName+'</a>';
        }
    },{
        field:"taskEndTime",
        title:"过期时间",
        width:"10%",
        align:"center"
    },{
        field:"handdle",
        title:"操作",
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            var remove='<a class="delete" href="javascript:void(0)" title="删除"><i class="glyphicon glyphicon-trash"></i></a>';
            var release='<a class="release" href="javascript:void(0)" title="发布任务"><i class="glyphicon glyphicon-star-empty"></i></a>';
            var update='<a class="update" href="javascript:void(0)" title="修改任务"><i class="glyphicon glyphicon-pencil"></i></a>';
            return release+update+remove;
        },
        events:'operateEvents'
    }];
    $("#noReleaseTable").bootstrapTable(noReleaseTable);
    var releaseTable=conf;
    releaseTable.url = CTX+"/task/findReleasePage";
    releaseTable.columns=[{
        field:"releaseTime",
        title:"发布时间",
        width:"15%"
    },{
        field:"taskName",
        title:"任务标题",
        width:"50%",
        formatter:function(value,row,index) {
        	return '<a href="'+CTX+'/task/taskDetail?taskId='+row.taskId+'">'+row.taskName+'</a>';
        }
    },{
        field:"taskEndTime",
        title:"过期时间",
        width:"10%",
        align:"center"
    },{
        field:"taskStatus",
        title:"任务状态",
        width:"10%",
        align:"center"
    },{
        field:"handdle",
        title:"操作",
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            var complete="";
            var cancel="";
            if(row.submitOrCancel){
            	complete='<a class="complete" href="javascript:void(0)" title="确认完成"><i class="glyphicon glyphicon-off"></i></a>';
            	cancel='<a class="cancel" href="javascript:void(0)" title="取消任务"><i class="glyphicon glyphicon-remove"></i></a>';
            }else{
            	complete='<span title="确认完成"><i class="glyphicon glyphicon-off"></i></span>';
            	cancel='<span title="取消任务"><i class="glyphicon glyphicon-remove"></i></span>';
            }
            return complete+cancel;
        },
        events:'operateEvents'
    }];
    $("#releaseTable").bootstrapTable(releaseTable);

    $("#submitLeader").click(function(){
        swal({
            title: "转移队长",
            text: "你确定要转移队长身份吗?",
            type: "warning",
            cancelButtonText:"取消",
            CancelButtonColor: "#cccccc",
            confirmButtonText: "确定",
            showCancelButton: true,
            closeOnConfirm: false,
            animation: "slide-from-top",
            html: true
        }, function(inputValue){
        		var params = $('#changeLeaderForm').serialize();
        		$.post(CTX+'/task/changeLeader', params, function(data) {
        			if(!data.error){
        				swal("提示", "转移请求已发出,等待对方确认", "info");
        				$("#transCaptionModal").modal("hide");
        				$("#myAcceptTable").bootstrapTable("refresh");
        			}else{
        				swal(data.message);
        			}
        		});
            }
        );

    });
    $("#taskFile").fileinput({
        language: 'zh', //设置语言
        uploadUrl: CTX+"/tool/uploadFile", //上传的地址
        allowedFileExtensions :allowFileList,//接收的文件后缀,
        autoReplace: true,
        maxFileCount: 1,
        showUpload: true, //是否显示上传按钮
        showCaption: true,//是否显示标题
        browseClass: "btn btn-primary" //按钮样式
    });
    
    $("#taskFile").on("fileuploaded", function (e, data) {
    	$("#attachmentId").val('');
    	if(data.response.errorUpload){
    		swal(data.response.message)
    	}else{
    		$("#attachmentId").val(data.response.attachmentId);
    	}
    });
    
    $("#submitResult").click(function(){
    	var params = $('#submitTaskForm').serialize();
    	$.post(CTX+'/task/submitResult', params, function(data) {
    		if (!data.error) {
    			$("#submitTaskModal").modal("hide");
    			swal('提交成功');
    			$("#myAcceptTable").bootstrapTable("refresh");
    		} else {
    			swal(data.message);
    		}
    	});
    });
    
});


function transCaption(taskId){
	swal({
		title:"转移队长",
		text: "您确定要转移队长吗?",
		type: "info",
		showCancelButton: true,
		cancelButtonText:"取消",
		CancelButtonColor: "#cccccc",
		confirmButtonText: "确定",
		closeOnConfirm: true
	},function(){
		$.post(CTX+'/taskUser/findNotLeaderByTaskId', {taskId : taskId}, function(data) {
			$("#leaderTaskId").val(taskId);
			$("#newCaption").empty();
			for(var i=0;i<data.length;i++){
				$("#newCaption").append("<option value='"+data[i].memberUserId+"'>"+data[i].memberUserAccount+"</option>");
			}
			$('#newCaption').selectpicker({
				dropupAuto:true,
				liveSearch:true,
				selectOnTab:true,
				size:15,
				liveSearchPlaceholder:"请输入关键字搜索"
			});
			$('#newCaption').selectpicker("refresh");
			$("#transCaptionModal").modal("show");
		});
	});
}