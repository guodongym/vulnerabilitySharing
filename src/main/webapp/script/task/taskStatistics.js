/**
 * Created by kingsir on 16/8/7.
 */

$(document).ready(function () {
    $("#summaryBar").height($("#summaryBar").width()*2/3);
    $("#typeBar").height($("#typeBar").width()*2/3);
    $("#timeLineTab").height(363);
    $("#timeLineTab").width($('#summary').width()-30);
   
    
    $.post(CTX+'/task/findTaskStatistic', {}, function(data) {
    	setSummaryBar(data.taskStatusStatistic);
    	setTypeBar(data.taskTypeStatistic);
	});
    
    $.post(CTX+'/task/findTaskTimeLine', {}, function(data) {
    	setTimeLine(data);
    });
    
    setPersonTable();
    setCompanyTable();
});

//概要统计
function setSummaryBar(taskStatusStatistic) {
    // 基于准备好的dom，初始化echarts图表
    var myChart = echarts.init(document.getElementById('summaryBar'));
    
    var data=[];
    var legendData = [];
    for (var int = 0; int < taskStatusStatistic.length; int++) {
		var result={
			"value":taskStatusStatistic[int].countTask,
			"name":taskStatusStatistic[int].taskStatus
		}
		legendData.push(taskStatusStatistic[int].taskStatus)
		data.push(result)
	}
    var option = {
        title : {
            text: '状态统计',
            subtext: '截止当前时间',
            x:'center'
        },
        tooltip : {
            trigger: 'item',
            formatter: "{a} <br/>{b} : {c} ({d}%)"
        },
        legend: {
            orient : 'vertical',
            x : 'left',
            data:legendData
        },
        toolbox: {
            show : true,
            feature : {
                dataView : {show: true, readOnly: true},
                magicType : {
                    show: true,
                    type: ['pie', 'funnel'],
                    option: {
                        funnel: {
                            x: '25%',
                            width: '50%',
                            funnelAlign: 'left',
                            max: 1548
                        }
                    }
                }
            }
        },
        calculable : true,
        series : [
            {
                name:'任务统计',
                type:'pie',
                radius : '55%',
                center: ['50%', '60%'],
                data:data
            }
        ]
    };
    // 为echarts对象加载数据
    myChart.setOption(option);
}
//类型统计
function setTypeBar(taskTypeStatistic){
    var myChart = echarts.init(document.getElementById('typeBar'));
    
    var data=[];
    var legendData = [];
    for (var int = 0; int < taskTypeStatistic.length; int++) {
		legendData.push(taskTypeStatistic[int].taskTypeName)
		data.push(taskTypeStatistic[int].countTask)
	}
    var option  = {
        title : {
            text: '任务类型统计',
            subtext: '截止当前时间',
            x:'center'
        },
        tooltip : {
            trigger: 'axis'
        },
        toolbox: {
            show : true,
            feature : {
                dataView : {show: true, readOnly: true},
                magicType: {show: true, type: ['line', 'bar']},
                restore : {show: true},
            }
        },
        calculable : true,
        xAxis : [
            {
                type : 'value',
                boundaryGap : [0, 0.01]
            }
        ],
        yAxis : [
            {
                type : 'category',
                data : legendData
            }
        ],
        series : [
            {
                name:'数量',
                type:'bar',
                data:data
            }
        ]
    };
    myChart.setOption(option);
}

function setPersonTable() {
    var tableConf={
        url:CTX+'/task/findPagePersonalTaskRanks',
        pagination: true,
        pageList: [10,15,20],//可以选择一页显示 几行
        pageSize:10,//默认一页显示 几行
        pageNumber:1,//默认显示第几页
        sidePagination:'server',//设置为服务器端分页
        showRefresh: true,//刷新按钮
        striped: true,//是否循环变色
        toolbar:"#toolbar",
        toolbarAlign:"right",
        columns:[{
            field:"order",
            title:"排名",
            width:"5%",
            align:"center",
            formatter:function (value,row,index) {
                return index+1;
            }
        },{
            field:"nickName",
            title:"账号",
            width:"25%",
            align:"center",
            formatter:function (value,row,index) {
                return '<a href="'+CTX+'/toUserInfo?userID='+row.userId+'">'+row.nickname+'</a>'
            }
        },{
            field:"userGroupName",
            title:"组",
            width:"20%",
            align:"center"
        },{
            field:"departmentName",
            title:"组织",
            width:"30%",
            align:"center"
        },{
            field:"countTask",
            title:"接受任务数",
            width:"10%",
            align:"center"
        },{
            field:"taskScore",
            title:"积分",
            width:"10%",
            align:"center"
        }]
    };
    $('#personalTable').bootstrapTable(tableConf);
}

function setCompanyTable() {
    var tableConf = {
        url:CTX+'/task/findPageDepartmentTaskRanks',
        pagination: true,
        pageList: [10, 15, 20],//可以选择一页显示 几行
        pageSize: 10,//默认一页显示 几行
        pageNumber: 1,//默认显示第几页
        sidePagination:'server',//设置为服务器端分页
        showRefresh: true,//刷新按钮
        striped: true,//是否循环变色
        toolbar: "#toolbar",
        toolbarAlign: "right",
        columns: [{
            field: "order",
            title: "排名",
            width: "5%",
            align: "center",
            formatter: function (value, row, index) {
                return index + 1;
            }
        }, {
            field: "departmentName",
            title: "组织名称",
            width: "50%"
        }, {
            field: "countUser",
            title: "人数",
            width: "15%",
            align: "center"
        }, {
            field: "countTask",
            title: "接受任务数",
            width: "15%",
            align: "center"
        }, {
            field: "sumScore",
            title: "积分",
            width: "15%",
            align: "center"
        }]
    };
    $('#companyTable').bootstrapTable(tableConf);
}
function setTimeLine(data) {
    var myChart = echarts.init(document.getElementById('timeLineTab'));
    var timeLineData = [];
    var options = [];
    for (var key in data) {
    	timeLineData.push(key);
    	var userData=[];
    	var scores=[];
    	for ( var i in data[key]) {
			userData.push(data[key][i].nickname)
			scores.push(data[key][i].sumScore)
		}
		console.log(userData);
        console.log(scores);
    	var series=[];
    	var serie={
            'name':'积分',
            'type':'bar',
            'markLine':{
                symbol : ['arrow','none'],
                symbolSize : [4, 2],
                itemStyle : {
                    normal: {
                        lineStyle: {color:'orange'},
                        barBorderColor:'orange',
                        label:{
                            position:'right',
                            formatter:function(params){
                                return Math.round(params.value);
                            },
                            textStyle:{color:'orange'}
                        }
                    }
                },
                'data':[{'type':'average','name':'平均值'}]
            },
            'data':scores
    	}
    	series.push(serie);
    	var op = {
                title : {
                    'text':key+'积分统计',
                    'subtext':'积分按年统计'
                },
                tooltip : {'trigger':'axis'},
                legend : {
                    x:'right',
                    'data':['积分'],
                    'selected':{
                        '积分':true
                    }
                },
                toolbox : {
                    'show':true,
                    orient : 'vertical',
                    x: 'right',
                    y: 'center',
                    'feature':{
                        'dataView':{'show':true,'readOnly':false},
                        'magicType':{'show':true,'type':['line','bar']},
                    }
                },
                calculable : true,
                grid : {'y':80,'y2':100},
                xAxis : [{
                    'type':'category',
                    'axisLabel':{'interval':0},
                    'data':userData
                }],
                yAxis : [
                    {
                        'type':'value',
                        'name':'积分',
                        'max':100
                    }
                ],
                series : series
            }
    	options.push(op);
	}
    var option = {
        timeline:{
            data:timeLineData,
            label : {
                formatter : function(s) {
                    return s.slice(0, 4);
                }
            },
            autoPlay : false,
            playInterval : 1000,
            currentIndex:timeLineData.length-1,
            notMerge:true
        },
        options:options
    };
    console.log(option)
    myChart.setOption(option);
}