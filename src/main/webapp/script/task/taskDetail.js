$(document).ready(function(){
	$("#acceptButton").click(function(){
		swal({
    		title:"接受任务",
    		text: "确定要接受任务？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/receive', {taskId : $("#tmpTaskId").val()}, function(data) {
        		if (!data.error) {
    				swal({
    					title:"提示",
    					text: "接受成功",
    					type: "info",
    					showCancelButton: false,
    					confirmButtonText: "确定",
    					closeOnConfirm: true
    				},function(){
    					window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
    				})
        		} else {
        			swal(data.message);
        		}
        	});
    	});
	});
	
	$("#submitButton").click(function(){
		$("#taskFile").fileinput({
	        language: 'zh', //设置语言
	        uploadUrl: CTX+"/tool/uploadFile", //上传的地址
	        allowedFileExtensions :allowFileList,//接收的文件后缀,
	        autoReplace: true,
	        maxFileCount: 1,
	        showUpload: true, //是否显示上传按钮
	        showCaption: true,//是否显示标题
	        browseClass: "btn btn-primary" //按钮样式
	    });
	    
	    $("#taskFile").on("fileuploaded", function (e, data) {
	    	$("#attachmentId").val('');
	    	if(data.response.errorUpload){
	    		swal(data.response.message)
	    	}else{
	    		$("#attachmentId").val(data.response.attachmentId);
	    	}
	    });
	    
	    $("#submitTaskModal").modal("show");
	});
	
	
	$("#submitResult").click(function(){
		var params = $('#submitTaskForm').serialize();
		$.post(CTX+'/task/submitResult', params, function(data) {
			if (!data.error) {
				$("#submitTaskModal").modal("hide");
				swal({
					title:"提示",
					text: "提交成功",
					type: "info",
					showCancelButton: false,
					confirmButtonText: "确定",
					closeOnConfirm: true
				},function(){
					window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
				})
			} else {
				swal(data.message);
			}
		});
	});


	$("#changeButton").click(function(){
		$.post(CTX+'/taskUser/findNotLeaderByTaskId', {taskId : $("#tmpTaskId").val()}, function(data) {
			$("#newCaption").empty();
			for(var i=0;i<data.length;i++){
				$("#newCaption").append("<option value='"+data[i].memberUserId+"'>"+data[i].memberUserAccount+"</option>");
			}
			$('#newCaption').selectpicker({
				dropupAuto:true,
				liveSearch:true,
				selectOnTab:true,
				size:15,
				liveSearchPlaceholder:"请输入关键字搜索"
			});
			$("#transCaptionModal").modal("show");
		});
	});
	
	
	$("#submitLeader").click(function(){
        swal({
            title: "转移队长",
            text: "你确定要转移队长身份吗?",
            type: "warning",
            cancelButtonText:"取消",
            CancelButtonColor: "#cccccc",
            confirmButtonText: "确定",
            showCancelButton: true,
            closeOnConfirm: false,
            animation: "slide-from-top",
            html: true
        }, function(inputValue){
        		var params = $('#changeLeaderForm').serialize();
        		$.post(CTX+'/task/changeLeader', params, function(data) {
        			if(!data.error){
						swal({
							title:"提示",
							text: "转移请求已发出,等待对方确认",
							type: "info",
							showCancelButton: false,
							confirmButtonText: "确定",
							closeOnConfirm: true
						},function(){
							$("#transCaptionModal").modal("hide");
							window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
						})
        			}else{
        				swal(data.message);
        			}
        		});
            }
        );

    });

	
	$("#receiveLeaderButton").click(function(){
		swal({
    		title:"接受队长",
    		text: "确定要接受队长？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/receiveLeader', {taskId : $("#tmpTaskId").val()}, function(data) {
    			if(!data.error){
    				swal({
    					title:"提示",
    					text: "接受队长成功",
    					type: "info",
    					showCancelButton: false,
    					confirmButtonText: "确定",
    					closeOnConfirm: true
    				},function(){
    					window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
    				})
    			}else{
    				swal(data.message);
    			}
    		});
    	});
	});
	
	
	$("#refuseLeaderButton").click(function(){
		//确认提示
		swal({
    		title:"拒绝接受队长",
    		text: "确定要拒绝接受队长？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/refuseLeader', {taskId : $("#tmpTaskId").val()}, function(data) {
    			if(!data.error){
    				window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
    			}else{
    				swal(data.message);
    			}
    		});
    	});
		
	});
	
	
	$("#releaseButton").click(function(){
		//确认提示
		swal({
    		title:"发布任务",
    		text: "确定要发布任务？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/release', {taskId : $("#tmpTaskId").val()}, function(data) {
    			if(!data.error){
    				swal({
    					title:"提示",
    					text: "发布成功",
    					type: "info",
    					showCancelButton: false,
    					confirmButtonText: "确定",
    					closeOnConfirm: true
    				},function(){
    					window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
    				})
    			}else{
    				swal(data.message);
    			}
    		});
    	});
		
	});


	$("#updateButton").click(function(){
		window.location.href = CTX+"/task/update?taskId="+$("#tmpTaskId").val();
	});

	$("#deleteButton").click(function(){
		//确认提示
		swal({
    		title:"删除任务",
    		text: "确定要删除任务？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/delete', {taskId : $("#tmpTaskId").val()}, function(data) {
        		if(!data.error){
    				swal({
    					title:"提示",
    					text: "删除成功",
    					type: "info",
    					showCancelButton: false,
    					confirmButtonText: "确定",
    					closeOnConfirm: true
    				},function(){
    					window.location.href=CTX+"/toMyTask";
    				})
        		}else{
        			swal(data.message);
        		}
        	});
    	});
	});
	
	$("#completeButton").click(function(){
		//确认提示
		swal({
    		title:"完成任务",
    		text: "确定已完成任务？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/complete', {taskId :  $("#tmpTaskId").val()}, function(data) {
        		if(!data.error){
    				swal({
    					title:"提示",
    					text: "确认成功",
    					type: "info",
    					showCancelButton: false,
    					confirmButtonText: "确定",
    					closeOnConfirm: true
    				},function(){
    					window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
    				})
        		}else{
        			swal(data.message);
        		}
        	});
    	});
	});
	
	$("#cancelButton").click(function(){
		//确认提示
		swal({
    		title:"取消任务",
    		text: "确定要取消任务？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/cancel', {taskId : $("#tmpTaskId").val()}, function(data) {
        		if(!data.error){
    				swal({
    					title:"提示",
    					text: "取消成功",
    					type: "info",
    					showCancelButton: false,
    					confirmButtonText: "确定",
    					closeOnConfirm: true
    				},function(){
    					window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
    				})
        		}else{
        			swal(data.message);
        		}
        	});
    	});
	});
});

function setMark(mark){
	var userMark=$(".userMark");
	var total=0;
	if(userMark.length==0){
		swal("没有人接受任务");
		return false;
	}
	for(var i=0;i<userMark.length;i++){
		var s=parseInt(userMark[i].value);
		if(!IsNum(userMark[i].value)){
			swal("请输入纯数字！");
			return;
		}else{
			total+=s;
		}
	}
	
	if(total>mark){
		swal("分配积分多于设定积分！")
		return;
	}
	var params = $('#markForm').serialize();
	$.post(CTX+'/task/mark', params, function(data) {
		if(!data.error){
			swal({
				title:"提示",
				text: "分配成功",
				type: "info",
				showCancelButton: false,
				confirmButtonText: "确定",
				closeOnConfirm: true
			},function(){
				window.location.href=CTX+"/task/taskDetail?taskId="+ $("#tmpTaskId").val();
			})
		}else{
			swal(data.message);
		}
	});
}

function IsNum(num){
	var reNum=/^\d+$/;
	return(reNum.test(num));
}
