/**
 * Created by kingsir on 16/8/3.
 */

window.operateEvents = {
    //接受任务按钮操作事件
    'click .accept': function (e, value, row, index) {
    	//接受任务确认
    	swal({
    		title:"接受任务",
    		text: "确定要接受任务？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		$.post(CTX+'/task/receive', {taskId : row.taskId}, function(data) {
        		if (!data.error) {
                    swal({
                        title:"提示",
                        text: "接受成功",
                        type: "info",
                        showCancelButton: false,
                        confirmButtonText: "确定",
                        closeOnConfirm: true
                    },function(){
                        window.location.href=CTX+"/toMyTask";
                    })
        		} else {
        			swal(data.message);
        		}
        	});
    		
    	});    
    }
};

function tableInit(){
    var taskTable={
        columns:[{
            field:"releaseTime",
            title:"发布时间",
            width:"15%"
        },{
            field:"taskName",
            title:"任务标题",
            width:"30%",
            formatter:function(value,row,index){
                return '<a href="'+CTX+'/task/taskDetail?taskId='+row.taskId+'">'+row.taskName+'</a>';
            }
        }, {
            field: "taskStatus",
            title: "任务状态",
            width: "10%",
            align:"center",
        },{
            field:"leaderUserAccount",
            title:"队长",
            width:"10%",
            align:"center",
        },{
            field:"taskNum",
            title:"限定人数",
            width:"5%",
            align:"center",
        },{
            field:"sumParticipator",
            title:"参与人数",
            width:"5%",
            align:"center",
        },{
            field:"taskScore",
            title:"任务积分",
            width:"5%",
            align:"center",
        },{
            field:"releaseUserAccount",
            title:"发布人",
            width:"10%",
            align:"center",
            formatter:function(value,row,index){
                return '<a href="'+CTX+'/toUserInfo?userID='+row.releaseUserId+'">'+row.releaseUserAccount+'</a>';
            }
        },{
            field:"haddle",
            title:"操作",
            width:"10%",
            align:"center",
            formatter:function(value,row,index){
                if(row.receive){
                    return '<a class="accept" title="接受任务"><i class="glyphicon glyphicon-heart"></i></a>';
                }else{
                    return '<span title="接受任务"><i class="glyphicon glyphicon-heart"></i></span>';
                }
            },
            events:'operateEvents'
        }],
        method: 'post',
        contentType: "application/x-www-form-urlencoded",
        url:CTX+'/task/findPage',
    	pagination: true,
        pageList:[5, 10, 15, 20, 25],//可以选择一页显示 几行
    	pageSize:5,//默认一页显示 几行
    	pageNumber:1,//默认显示第几页
    	sidePagination:'server',//设置为服务器端分页
    	search: true,
    	cache: false,
    	showRefresh: true,//刷新按钮
    	striped: true,//是否循环变色
        paginationPreText:"前一页",
        paginationNextText:"后一页",
        toolbar:"#toolbar",
        toolbarAlign:"right",
        showPaginationSwitch:true
    };
    $('#taskTable').bootstrapTable(taskTable);
}

function setType(){
	$.post(CTX+'/taskType/findAll', {}, function(data) {
		$("#taskType").append("<option value='0'>请选择</option>")
		for(var i=0;i<data.length;i++){
	        $("#taskType").append("<option value="+ data[i].id +">"+data[i].taskName+"</option>")
	    }
	    $('#taskType').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:5,
	        liveSearchPlaceholder:"请输入关键字搜索",
	        width:"50%"
	    });
	});
	
	$('#taskStatus').selectpicker({
        dropupAuto:true,
        liveSearch:true,
        selectOnTab:true,
        size:5,
        liveSearchPlaceholder:"请输入关键字搜索",
        width:"50%"
    });
}
$(document).ready(function(){
    setType();
    
    var dateConf={
        format: 'yyyy-mm-dd',
        autoclose: true,
        startDate: "2016-07-01",
        startView:2,
        minView:2,
        maxView:4,
        language:"zh-CN",
        bootcssVer:3
    }
    $("#createStartTime").datetimepicker(dateConf);
    $("#createEndTime").datetimepicker(dateConf);

    tableInit();
    
    $("#submitSearch").click(function(){
    	$('#searchModal').modal('hide');
    	$('#taskTable').bootstrapTable('refresh',{
            query:{
            	search : '',
                likeKeyWord : $("#key").val(),
                taskTypeId : $("#taskType").val(),
                status : $("#taskStatus").val(),
                createStarTime : $("#createStartTime").val(),
                createEndTime : $("#createEndTime").val()
            }
        });
    });
});