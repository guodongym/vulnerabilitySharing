/**
 * Created by kingsir on 16/7/8.
 *
 * 包含一个ajax请求
 */
window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	//更新工具类型
    	updateToolType(row);
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	swal({
    		title:"删除工具类型",
    		text: "确定删除吗？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		deleteToolType(row.id);
    	});
    }
};


//更新工具类型
function updateToolType(row){
	//重置form表单
	resetForm();
	$("#toolTypeId").val(row.id);
	$("#toolTypeName").val(row.toolTypeName);
	$(":reset").attr("disabled",true);
	$("#modalLabel").html("修改工具类型");
	$.post(CTX+'/toolType/findAll', {}, function(data) {
		$("#preTypeName").empty();
	    var html = '';
	    html+=' <option value="0">-</option> ';
	    for(var i=0;i<data.length;i++){
	    	html= html+"<option value='"+data[i].id+"'>"+data[i].toolName+"</option>";
	    }
	    $("#preTypeName").html(html);
	    
	    $('#preTypeName').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:10,
	        liveSearchPlaceholder:"请输入关键字搜索"
	    });
	    $("#preTypeName").selectpicker('val', row.parentId);
	    $("#preTypeName").selectpicker('refresh');
	    $("#toolTypeAddModal").modal("show");
	});
	
}

//删除工具类型
function deleteToolType(toolTypeId){
	$.post(CTX+'/toolType/deleteToolType', {id:toolTypeId}, function(data) {
		if (!data.error) {
			swal('删除成功');
			$('#toolType_table').bootstrapTable('refresh');
		} else {
			swal(data.message);
		}
	});
}

var toolTpye_table={
	url:CTX+'/toolType/findPageToolTypes',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
    columns:[{
        checkbox:true,
        width:"5%"
    },{
        field:"toolTypeName",
        title:"类型名称",
        width:"40%"
    },{
        field:"parentToolTypeName",
        title:"父类型",
        width:"40%"
    },{
        field:"haddle",
        title: '操作',
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            return [
                '<a class="update" href="javascript:void(0)" title="修改">',
                '<i class="glyphicon glyphicon-pencil"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="删除">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('');
        },
        events:'operateEvents'
    }],
};
$('#toolType_table').bootstrapTable(toolTpye_table);

$(document).ready(function(){
    //保存工具类型操作
    $("#submit").click(function(){
        var name=$("#toolTypeName").val();
        if(name.length<1){
            swal("提示", "请输入类型名称", "info");
            return;
        }
        //工具类型校验
        var testStr=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,20}$/;
        if(!testStr.test(name)){
            swal("提示", "工具类型只能是20个以内中文/字母/数字/下划线", "info");
            return;
        }
        //保存工具类型
        saveOrUpdateToolType();
    });
    //批量删除操作
    $("#delete_toolTpye").click(function(){
        var selections=$('#toolType_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的类型", "info");
            return;
        }
        swal({
    		title:"删除工具类型",
    		text: "确定删除吗？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		deleteToolTypes(selections);
    	});
    });
});

//删除该漏洞
function  deleteToolTypes(selections){
var idListString=[];
for(var i=0;i<selections.length;i++){
idListString.push(selections[i].id);
}
console.log(idListString);

//批量删除漏洞类型 
$.post(CTX+'/toolType/deleteToolTypeList',
	{ idListString:JSON.stringify(idListString)}, function(data) {
if (!data.error) {
	swal('删除成功');
	$('#toolType_table').bootstrapTable('refresh');
} else {
	swal(data.message);
}
});

}

//添加/修改工具类型
function saveOrUpdateToolType(){
	$.post(CTX+'/toolType/saveOrUpdateToolType', $("#toolTypeAddForm").serialize(), function(data) {
		if (!data.error) {
			swal('保存成功');
			$('#toolType_table').bootstrapTable('refresh');
			//关闭弹出框
			$('#toolTypeAddModal').modal('toggle');
		} else {
			swal(data.message);
		}
	});
	
}

function setOption(){
    $("#toolTypeAddForm")[0].reset();
    $("#toolTypeId").val(null);
    $(":reset").attr("disabled",false);
    $("#preTypeName").empty();
    setParentToolTypes();
}

//显示所有工具类型
function setParentToolTypes(){
	//显示"添加漏洞类型"
	$("#modalLabel").html("添加工具类型");
	 //获取所有漏洞类型
	$.post(CTX+'/toolType/findAll', {}, function(data) {
		console.log(data);
		$("#preTypeName").append(' <option value="0">-</option>');
		for(var i=0;i<data.length;i++){
		   $("#preTypeName").append("<option value='"+data[i].id+"'>"+data[i].toolName+"</option>");
	    }
	    $('#preTypeName').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:10,
	        liveSearchPlaceholder:"请输入关键字搜索"
	    });
	    $("#preTypeName").selectpicker('val', "1");
	    $("#preTypeName").selectpicker('refresh');
	});
}


//去添加工具类型
$(function(){
	$("#toAddToolType").click(function(){
		//重置添加窗口
		resetForm()
		//显示"添加组织"
		$("#modalLabel").html("添加工具类型"); 
		 //获取所有漏洞类型
		$.post(CTX+'/toolType/findAll', {}, function(data) {
			console.log(data);
			$("#preTypeName").append(' <option value="0">-</option>');
			for(var i=0;i<data.length;i++){
			   $("#preTypeName").append("<option value='"+data[i].id+"'>"+data[i].toolName+"</option>");
		    }
		    $('#preTypeName').selectpicker({
		        dropupAuto:true,
		        liveSearch:true,
		        selectOnTab:true,
		        size:10,
		        liveSearchPlaceholder:"请输入关键字搜索"
		    });
		    $("#preTypeName").selectpicker('val', "0");
		    $("#preTypeName").selectpicker('refresh');
	        $("#toolTypeAddModal").modal("show");
		});
	});
});

//重置form表单
function resetForm(){
	$(":reset").attr("disabled",false);
	$(":reset").trigger("click");
	$("#toolTypeId").val(null);
	$("#preTypeName").empty();
}