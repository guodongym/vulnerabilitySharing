/**
 * Created by kingsir on 16/7/8.
 */

window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	//更新任务类型
    	toUpdateTaskType(row);
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	//删除任务类型
    	deleteTaskType(row.id);
    }
};



//更新任务类型
function toUpdateTaskType(row){
	//重置添加窗口
	resetForm()
	//显示"添加组织"
	$("#modalLabel").html("修改任务类型"); 
	$(":reset").attr("disabled",true);
	
	$("#taskTypeId").val(row.id);
	$("#taskTypeName").val(row.taskName);
	
	$.post(CTX+'/taskType/findAll', {}, function(data) {
		$("#preTypeName").append("<option value='0'>-</option>")
	    for(var i=0;i<data.length;i++){
	        $("#preTypeName").append("<option value='"+data[i].id+"'>"+data[i].taskName+"</option>");
	    }
	    $('#preTypeName').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:10,
	        liveSearchPlaceholder:"请输入关键字搜索"
	    });
	    $("#preTypeName").selectpicker('val', row.parentId);
	    $("#preTypeName").selectpicker('refresh');
	    $("#taskTypeAddModal").modal("show");
	});
}


//删除任务类型
function deleteTaskType(taskTypeId){
	swal({
		title:"删除任务类型",
		text: "确定要删除该任务类型？",
		type: "warning",
		showCancelButton: true,
		cancelButtonText:"取消",
		CancelButtonColor: "#cccccc",
		confirmButtonText: "确定",
		closeOnConfirm: true
	},function(){
		$.post(CTX+'/taskType/deleteTaskType', {id:taskTypeId}, function(data) {
			if (!data.error) {
				swal('删除成功');
				$('#taskType_table').bootstrapTable('refresh');
			} else {
				swal(data.message);
			}
		});
	});
}

var taskTpye_table={
	url:CTX+'/taskType/findPageTaskTypes',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
    columns:[{
        checkbox:true,
        width:"5%"
    },{
        field:"taskName",
        title:"类型名称",
        width:"40%"
    },{
        field:"parentTaskName",
        title:"父类型",
        width:"40%"
    },{
        field:"haddle",
        title: '操作',
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            return [
                '<a class="update" href="javascript:void(0)" title="修改">',
                '<i class="glyphicon glyphicon-pencil"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="删除">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('');
        },
        events:'operateEvents'
    }]
};
$('#taskType_table').bootstrapTable(taskTpye_table);

$(document).ready(function(){
    //保存漏洞类型操作
    $("#submit").click(function(){
        var name=$("#taskTypeName").val();
        if(name.length<1){
            swal("提示", "请输入类型名称", "info");
            return;
        }
        var testStr=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,20}$/;
        if(!testStr.test(name)){
            swal("提示", "单位称只能是20个以内中文/字母/数字/下划线", "info");
            return;
        }
        //保存/更新任务类型
        saveOrUpdateTaskType();
        
    });
    //批量删除操作
    $("#delete_taskTpye").click(function(){
        var selections=$('#taskType_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的类型", "info");
            return;
        }
        swal({
    		title:"删除任务类型",
    		text: "确定要删除该任务类型？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
        	 deleteTaskTypeList(selections);
        });
    });
});



//批量删除漏洞类型 
function  deleteTaskTypeList(selections){
	var idListString=[];
    for(var i=0;i<selections.length;i++){
    	idListString.push(selections[i].id);
    }
    
	//批量删除漏洞类型 
	$.post(CTX+'/taskType/deleteTaskTypeList',
			{ idListString:JSON.stringify(idListString)}, function(data) {
		if (!data.error) {
			swal('删除成功');
			$('#taskType_table').bootstrapTable('refresh');
		} else {
			swal(data.message);
		}
	});

}

//保存/更新任务类型
function saveOrUpdateTaskType(){
	 //保存/更新任务类型
	$.post(CTX+'/taskType/saveOrUpdateTaskType', $("#taskTypeAddForm").serialize(), function(data) {
		if (!data.error) {
			swal('保存成功');
			$('#taskType_table').bootstrapTable('refresh');
			//关闭弹出框
			$('#taskTypeAddModal').modal('toggle');
		} else {
			swal(data.message);
		}
	});
	
}
//去添加任务类型
$(function(){
	$("#toAddTaskType").click(function(){
		//重置添加窗口
		resetForm()
		//显示"添加组织"
		$("#modalLabel").html("添加任务类型"); 
		$.post(CTX+'/taskType/findAll', {}, function(data) {
			$("#preTypeName").append("<option value='0'>-</option>")
		    for(var i=0;i<data.length;i++){
		        $("#preTypeName").append("<option value='"+data[i].id+"'>"+data[i].taskName+"</option>");
		    }
		    $('#preTypeName').selectpicker({
		        dropupAuto:true,
		        liveSearch:true,
		        selectOnTab:true,
		        size:10,
		        liveSearchPlaceholder:"请输入关键字搜索"
		    });
		    $("#preTypeName").selectpicker('val', "0");
		    $("#preTypeName").selectpicker('refresh');
		    $("#taskTypeAddModal").modal("show");
		});
		   
	});
});


//重置form表单
function resetForm(){
	$(":reset").attr("disabled",false);
	$(":reset").trigger("click");
	$("#taskTypeId").val(null);
	$("#preTypeName").empty();
}