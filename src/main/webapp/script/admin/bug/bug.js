/**
 * Created by kingsir on 16/7/8.
 *
 * 包含一个ajax请求
 */
window.operateEvents = {
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	swal({
    		title:"删除漏洞",
    		text: "确定要删除该漏洞？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		deleteLeak(row.id);
    	});
    }
};


//删除该漏洞
function deleteLeak(leakId){
	$.post(CTX+'/leak/deleteLeak', {id:leakId}, function(data) {
		if (!data.error) {
			swal({
				title:"提示",
				text: "删除成功",
				type: "info",
				showCancelButton: false,
				confirmButtonText: "确定",
				closeOnConfirm: true
			},function(){
				$('#bug_table').bootstrapTable('refresh');
			})
		} else {
			swal(data.message);
		}
	});
}

//table_init
var bug_table={
	url:CTX+'/leak/findPageLeaks',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
    columns:[{
        checkbox:true,
        width:"5%"
    },{
        field:"leakName",
        title:"漏洞名称",
        width:"50%",
        formatter:function(value,row,index){
            return '<a href="'+CTX+'/toUserInfo?userID='+row.id+'">'+row.leakName+'</a>'
        }
    },{
        field:"leakStatus",
        title:"状态",
        width:"15%"
    },{
        field:"countLeakComment",
        title:"评论数",
        width:"10%"
    },{
        field:"submitUserAccount",
        title:"发布人",
        width:"10%",
        formatter:function(value,row,index){
            return '<a href="'+CTX+'/toUserInfo?userID='+row.submitUserId+'">'+row.submitUserAccount+'</a>'
        }
    },{
        field:"haddle",
        title: '操作',
        width:"10%",
        align:"center",
        formatter:function(value,row,index){
            return [
                '<a class="remove" href="javascript:void(0)" title="删除">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('');
        },
        events:'operateEvents'
    }]
};
$('#bug_table').bootstrapTable(bug_table);

$(document).ready(function(){
    //批量删除操作
    $("#delete_bug").click(function(){
        var selections=$('#bug_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的漏洞", "info");
            return;
        }
        swal({
    		title:"删除漏洞",
    		text: "确定要删除这些漏洞？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
	   		deleteLeaks(selections);
    	});
    });
})
 //删除该漏洞
function  deleteLeaks(selections){
	var idListString=[];
    for(var i=0;i<selections.length;i++){
    	idListString.push(selections[i].id);
    }
	//批量删除漏洞
	$.post(CTX+'/leak/deleteLeakList',
			{ idListString:JSON.stringify(idListString)}, function(data) {
		if (!data.error) {
			swal({
				title:"提示",
				text: "删除成功",
				type: "info",
				showCancelButton: false,
				confirmButtonText: "确定",
				closeOnConfirm: true
			},function(){
				$('#bug_table').bootstrapTable('refresh');
			});
		} else {
			swal(data.message);
		}
	});
}