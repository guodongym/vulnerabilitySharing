/**
 * Created by kingsir on 16/7/6.
 *
 * 包含一个ajax请求
 */

window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	//更新漏洞类型
    	updateLeakType(row);
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
        deleteLeakType(row.id);
    }
};

//更新漏洞类型
function updateLeakType(row){
	//重置form表单
	resetForm();
	$("#bugTypeId").val(row.id);
	$("#typeName").val(row.leakName);
	$(":reset").attr("disabled",true);
	$("#modalLabel").html("修改漏洞类型");
	$.post(CTX+'/leakType/findAll', {}, function(data) {
		$("#preTypeName").empty();
	    var html = '';
	    html+=' <option value="0">-</option> ';
	    for(var i=0;i<data.length;i++){
	    	html= html+"<option value='"+data[i].id+"'>"+data[i].leakName+"</option>";
	    }
	    $("#preTypeName").html(html);
	    
	    $('#preTypeName').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:10,
	        liveSearchPlaceholder:"请输入关键字搜索"
	    });
	    $("#preTypeName").selectpicker('val', row.parentId);
	    $("#preTypeName").selectpicker('refresh');
	    $("#bugTypeAddModal").modal("show");
	});
}

//删除漏洞类型 
function deleteLeakType(leakTypeId){
	swal({
		title:"删除漏洞类型",
		text: "确定要删除该漏洞类型？",
		type: "warning",
		showCancelButton: true,
		cancelButtonText:"取消",
		CancelButtonColor: "#cccccc",
		confirmButtonText: "确定",
		closeOnConfirm: true
	},function(){
		$.post(CTX+'/leakType/deleteLeakType', {leakTypeId:leakTypeId}, function(data) {
			if (!data.error) {
				swal('删除成功');
				$('#bugTpye_table').bootstrapTable('refresh');
			} else {
				swal(data.message);
			}
		});
	});
}

var bugTpye_table={
	url:CTX+'/leakType/findPageLeakTypes',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
		   
    columns:[{
        checkbox:true,
        width:"5%"
    },{
        field:"leakName",
        title:"类型名称",
        width:"40%"
    },{
        field:"parentLeakName",
        title:"父类型",
        width:"40%"
    },{
        field:"haddle",
        title: '操作',
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            return [
                '<a class="update" href="javascript:void(0)" title="修改">',
                '<i class="glyphicon glyphicon-pencil"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="删除">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('');
        },
        events:'operateEvents'
    }],
};
$('#bugTpye_table').bootstrapTable(bugTpye_table);

//添加或修改漏洞信息
function saveOrUpdateLeakType(){
	 //添加或修改漏洞信息
	$.post(CTX+'/leakType/saveOrUpdateLeakType', $("#bugTypeAddForm").serialize(), function(data) {
		if (!data.error) {
			swal('保存成功');
			$('#bugTpye_table').bootstrapTable('refresh');
			//关闭弹出框
			$('#bugTypeAddModal').modal('toggle');
		} else {
			swal(data.message);
		}
	});
	
}

$(document).ready(function(){
    //保存漏洞类型操作
    $("#submit").click(function(){
        var name=$("#typeName").val();
        if(name.length<1){
            swal("提示", "请输入类型名称", "info");
            return;
        }
        //漏洞类型校验
        var testStr=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,20}$/;
        if(!testStr.test(name)){
            swal("提示", "漏洞类型名称只能是20个以内中文/字母/数字/下划线", "info");
            return;
        }

        //添加或修改漏洞信息
        saveOrUpdateLeakType();
    });
    //批量删除操作
    $("#delete_bugTpye").click(function(){
        var selections=$('#bugTpye_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的类型", "info");
            return;
        }
        swal({
    		title:"删除漏洞类型",
    		text: "确定要删除这些漏洞类型？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		deleteLeakTypeList(selections);
    	});
    });
});


//批量删除漏洞类型 
function  deleteLeakTypeList(selections){
	var idListString=[];
    for(var i=0;i<selections.length;i++){
    	idListString.push(selections[i].id);
    }
    console.log(idListString);
    
	//批量删除漏洞类型 
	$.post(CTX+'/leakType/deleteLeakTypeList',
			{ idListString:JSON.stringify(idListString)}, function(data) {
		if (!data.error) {
			swal('删除成功');
			$('#bugTpye_table').bootstrapTable('refresh');
		} else {
			swal(data.message);
		}
	});

}

function setOption(){
	//添加漏洞类型
	$("#modalLabel").html("添加漏洞类型");
    $("#bugTypeAddForm")[0].reset();
    $(":reset").attr("disabled",false);
    $("#preTypeName").empty();
    //显示父类型
    setParentLeakType();
    
}


//显示父类型
function setParentLeakType(){
	 //获取所有漏洞类型
	$.post(CTX+'/leakType/findAll', {}, function(data) {
		console.log(data);
	    var html = '';
	    html+=' <option value="0">-</option> ';
	    for(var i=0;i<data.length;i++){
	    	html= html+"<option value='"+data[i].id+"'>"+data[i].leakName+"</option>";
	    }
	    $("#preTypeName").html(html);
	    
	    $('#preTypeName').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:10,
	        liveSearchPlaceholder:"请输入关键字搜索"
	    });
	    $("#preTypeName").selectpicker('refresh');
	});
	
}

//生成添加漏洞类型的页面
$(function(){
	$("#toAddLeakType").click(function(){
		//重置form表单
		resetForm();
		$("#modalLabel").html("添加漏洞类型");
		//生成父类型
		 //获取所有漏洞类型
		$.post(CTX+'/leakType/findAll', {}, function(data) {
			console.log(data);
			$("#preTypeName").empty();
			$("#preTypeName").append('<option value="0">-</option>');
	        for(var i=0;i<data.length;i++){
	            $("#preTypeName").append("<option value='"+data[i].id+"'>"+data[i].leakName+"</option>");
	        }
		    $('#preTypeName').selectpicker({
		        dropupAuto:true,
		        liveSearch:true,
		        selectOnTab:true,
		        size:10,
		        liveSearchPlaceholder:"请输入关键字搜索"
		    });
		    $("#preTypeName").selectpicker('val', "0");
		    $("#preTypeName").selectpicker('refresh');
	        $("#bugTypeAddModal").modal("show");
		});
	})
});

//重置form表单
function resetForm(){
	$(":reset").attr("disabled",false);
	$(":reset").trigger("click");
	$("#bugTypeId").val(null);
}