/**
 * Created by kingsir on 16/7/6.
 *
 * 包含一个ajax数据
 */


window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	//去更新用户组
    	toUpdateGroup(row);
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	swal({
    		title:"删除组",
    		text: "确定删除吗？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
        	deleteUserGroup(row.id);
    	});
    }
};


//去更新用户组
function toUpdateGroup(row){
	resetForm();
	//显示"修改组"
	$("#modalLabel").html("修改组"); 
    $("#groupId").attr("value",row.id);
    $("#groupName").val(row.userGroupName);
    $(":reset").attr("disabled",true);
    $("#groupAddModal").modal("show");
}

//删除用户组
function deleteUserGroup(userGroupId){
	$.ajax({ 
    	url:CTX+'/sysUserGroup/deleteSysUserGroup', 
        type:'post',
        async: true,
        dataType:'json',
        data:{
        	id:userGroupId
        },
        success:function(data){
             //如果错误,弹出错误提示
             if(data.error){
            	 swal(data.message);
             }else{
                 swal("提示", data.message, "info");
            	 //刷新所有部门的列表
            	 $('#group_table').bootstrapTable('refresh');
             }
        },
        error:function(error){
        	swal("错误",error.status,"error");
        }
    });
	
}

//----------------加载分页的分组信息start----------------------------------------------------------//

var group_table={
	url:CTX+'/sysUserGroup/findPageSysUserGroups',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
    columns:[{
        checkbox:true,
        width:"5%"
    },{
        field:"userGroupName",
        title:"用户组",
        width:"80%"
    },{
        field:"haddle",
        title: '操作',
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            return [
                '<a class="update" href="javascript:void(0)" title="修改">',
                '<i class="glyphicon glyphicon-pencil"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="删除">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('');
        },
        events:'operateEvents'
    }]
};

$('#group_table').bootstrapTable(group_table);
//----------------加载分页的分组信息end----------------------------------------------------------//

$(document).ready(function(){
	$('#groupAddModal').on('hidden.bs.modal', function (e) {
		formInit()
	});

    //批量删除操作
    $("#removeGroups").click(function(){
        var selections=$('#group_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的组", "info");
            return;
        }
        swal({
    		title:"删除组",
    		text: "确定删除吗？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		deleletGroups(selections);
    	});
    });
});

//批量删除用户组
function  deleletGroups(selections){
	 var idListString=[];
     for(var i=0;i<selections.length;i++){
         idListString.push(selections[i].id);
     }
     //批量删除用户组
     $.ajax({ 
			 url:CTX+'/sysUserGroup/deleteSysUserGroupList', 
			 type:'post',
			 async: true,
			 dataType:'json',
			 data:{
				 idListString:JSON.stringify(idListString)
			 },
			 success:function(data){
			      //如果错误,弹出错误提示
			      if(data.error){
			     	 swal(data.message);
			      }else{
			     	 //成功,刷新所有用户组的列表
			          swal("提示", data.message, "info");
			        //刷新所有用户组的列表
		            $('#group_table').bootstrapTable('refresh');
			      }
			 },
			 error:function(error){
			 	swal("错误",error.status,"error");
			 }
	     });
}
//保存组
$("#submit").click(function(){
    var groupName=$("#groupName").val();
    var groupId=$("#groupId").val();
    if(groupName.length<1){
        swal("提示", "请输入组名称", "info");
        return;
    }
    //校验提交的用户组是否合法
//    var str=/^[\u2E80-\u9FFF|A-Za-z0-9_]+$/;
    var testStr=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,20}$/;
    if(!testStr.test(groupName)){
        swal("提示", "组名称只能20个以内的中文/英文/下划线/数字", "info");
        return;
    }
    //保存新增用户组信息
    addGroup(groupName,groupId);
});

//保存新增用户组信息
function addGroup(groupName,groupId){
	$.ajax({ 
    	url:CTX+'/sysUserGroup/saveOrUpdateSysUserGroup', 
        type:'post',
        async: true,
        dataType:'json',
        data:{
        	id:groupId,
        	userGroupName:groupName
        },
        success:function(data){
             //如果错误,弹出错误提示
             if(data.error){
            	 swal(data.message);
             }else{
            	 //成功,关闭添加框,刷新所有部门的列表
            	 // 关闭添加框
                 $('#groupAddModal').modal('toggle');
                 swal("提示", data.message, "info");
            	 //刷新所有用户组的列表
            	 $('#group_table').bootstrapTable('refresh');
             }
        },
        error:function(error){
        	swal("错误",error.status,"error");
        }
    });
}


function formInit(){
    $("#groupAddForm")[0].reset();
    $("#groupId").removeAttr("value");
}

//点击添加按钮,清空输入页面的信息
$("#toAddGroup").click(function(){
	//重置添加窗口
	resetForm()
	//显示"添加组"
	$("#modalLabel").html("添加组"); 
	$("#groupAddModal").modal("show");
});

//重置form表单
function resetForm(){
	$(":reset").attr("disabled",false);
	$(":reset").trigger("click");
	$("#groupId").val(null);
}