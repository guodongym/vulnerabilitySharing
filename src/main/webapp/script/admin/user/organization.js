/**
 * Created by kingsir on 16/7/6.
 *
 * 包含一个ajax请求
 */

//表格操作列绑定事件
window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	//修改部门信息
    	toUpdateDepartment(row);
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	swal({
	    		title: "你确定删除该组织吗?",
	    		text: "此操作将不可恢复!",
	    		type: "warning",
	    		showCancelButton: true,
	    		confirmButtonColor: "#DD6B55",
	    		cancelButtonText: "取消",
	    		confirmButtonText: "确定",
	    		closeOnConfirm: false,
	    		showLoaderOnConfirm: true
    		}, function(){
    			//删除一条部门信息
    	    	 $.ajax({ 
    				 url:CTX+'/sysDepartment/deleteSysDepartment', 
    				 type:'post',
    				 async: true,
    				 dataType:'json',
    				 data:{
    				     id:row.id
    				 },
    				 success:function(data){
    				      //如果错误,弹出错误提示
    				      if(data.error){
    				     	 swal(data.message);
    				      }else{
    				     	 //成功,刷新所有部门的列表
    				          swal("提示", data.message, "info");
    				     	 //刷新所有部门的列表
    				     	 $('#organization_table').bootstrapTable('refresh');
    				      }
    				 },
    				 error:function(error){
    				 	swal("出错了",error.status,"error");
    				 }
    		     });
			})
		}
};



//修改部门信息
function toUpdateDepartment(row){
	//重置添加框
	resetForm();
	$("#organizationId").val(row.id);
    $("#organizationName").val(row.departmentName);
    $(":reset").attr("disabled",true);
    //显示"修改组织"
	$("#modalLabel").html("修改组织"); 
	//父级部门
	$.ajax({
		url:CTX+'/sysDepartment/findSysDepartments', 
	    type:'post',
	    async:true,
	    dataType:'json',
	    data:{},
	    success:function(data){
	    	$("#preOrganization").empty();
	    	 $("#preOrganization").append("<option value='0'>无上级部门</option>");
		        for(var i=0;i<data.length;i++){
		            $("#preOrganization").append("<option value='"+data[i].id+"'>"+data[i].departmentName+"</option>");
		        }
		        
		        //	修改data为从后台获得 end

		        $('#preOrganization').selectpicker({
		            dropupAuto:true,
		            liveSearch:true,
		            selectOnTab:true,
		            size:10,
		            liveSearchPlaceholder:"请输入关键字搜索"
		        });
		        $("#preOrganization").selectpicker('val', row.parentDepartmentId);
		        $("#preOrganization").selectpicker('refresh');
		        $("#organizationAddModal").modal("show");
        },
        error:function(error){
        	swal(error)
        }
	});
	
}

var organization_table={
	url:CTX+'/sysDepartment/findPageSysDepartments',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
    columns:[{
        checkbox:true,
        width:"5%"
    },{
        field:"departmentName",
        title:"单位名称",
        width:"40%"
    },{
        field:"parentDepartmentName",
        title:"父组织",
        width:"40%"
    },{
        field:"haddle",
        title: '操作',
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            return [
                '<a class="update" href="javascript:void(0)" title="修改">',
                '<i class="glyphicon glyphicon-pencil"></i>',
                '</a>  ',
                '<a class="remove" href="javascript:void(0)" title="删除">',
                '<i class="glyphicon glyphicon-trash"></i>',
                '</a>'
            ].join('');
        },
        events:'operateEvents'
    }]
};
$('#organization_table').bootstrapTable(organization_table);

$(document).ready(function(){
	$('#organizationAddModal').on('hidden.bs.modal', function (e) {
		formInit()
	});
    //保存组织单位操作
    $("#submit").click(function(){
        var id=$("#organizationId").val();
        var name= $.trim($("#organizationName").val());
        var parentId=$("#preOrganization").val();
        if(name.length<1){
            swal("提示", "请输入单位名称", "info");
            return;
        }
//        var str=/^[\u2E80-\u9FFF|A-Za-z0-9_]+$/;
        var testStr=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,30}$/;
        if(!testStr.test(name)){
            swal("提示", "单位称只能是30个以内中文/字母/数字/下划线", "info");
            return;
        }
        $.ajax({ 
        	url:CTX+'/sysDepartment/saveOrUpdateSysDepartment', 
            type:'post',
            async: true,
            dataType:'json',
            data:{
                id:id,
            	departmentName:name,
            	parentId:parentId
            },
            success:function(data){
                 //如果错误,弹出错误提示
                 if(data.error){
                	 swal(data.message);
                 }else{
                	 //成功,关闭添加框,刷新所有部门的列表
                	 // 关闭添加框
                     $('#organizationAddModal').modal('toggle');
                     swal("提示", data.message, "info");
                	 //刷新所有部门的列表
                	 $('#organization_table').bootstrapTable('refresh');
                 }
            },
            error:function(error){
            	swal("错误",error.status,"error");
            }
        });
    });
    //批量删除操作
    $("#removeOrganizations").click(function(){
        var selections=$('#organization_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的组织", "info");
            return;
        }
        var idListString=[];
        for(var i=0;i<selections.length;i++){
            idListString.push(selections[i].id);
        }
        swal({
    		title: "你确定删除这些组织吗?",
    		text: "此操作将不可恢复!",
    		type: "warning",
    		showCancelButton: true,
    		confirmButtonColor: "#DD6B55",
    		cancelButtonText: "取消",
    		confirmButtonText: "确定",
    		closeOnConfirm: false,
    		showLoaderOnConfirm: true
		}, function(){
	        //批量删除部门信息
	        $.ajax({ 
				 url:CTX+'/sysDepartment/deleteSysDepartmentList', 
				 type:'post',
				 async: true,
				 dataType:'json',
				 data:{
					 idListString:JSON.stringify(idListString)
				 },
				 success:function(data){
				      //如果错误,弹出错误提示
				      if(data.error){
				     	 swal(data.message);
				      }else{
				     	 //成功,刷新所有部门的列表
				          swal("提示", data.message, "info");
				     	 //刷新所有部门的列表
				     	 $('#organization_table').bootstrapTable('refresh');
				      }
				 },
				 error:function(error){
				 	swal("错误",error.status,"error");
				 }
		     });
        });
    });
});
//去添加"组织部门信息"
$(function(){
	$("#toAddDepartment").click(function(){
		//重置添加窗口
		resetForm()
		//显示"添加组织"
		 $("#modalLabel").html("添加组织"); 
		//data为从后台获得
		$.ajax({
			url:CTX+'/sysDepartment/findSysDepartments', 
		    type:'post',
		    async:true,
		    dataType:'json',
		    data:{},
		    success:function(data){
			    $("#preOrganization").append("<option value='0'>无上级部门</option>");
		        for(var i=0;i<data.length;i++){
		            $("#preOrganization").append("<option value='"+data[i].id+"'>"+data[i].departmentName+"</option>");
		        }

		        $('#preOrganization').selectpicker({
		            dropupAuto:true,
		            liveSearch:true,
		            selectOnTab:true,
		            size:10,
		            liveSearchPlaceholder:"请输入关键字搜索"
		        });
		        $("#preOrganization").selectpicker('val', "0");
		        $("#preOrganization").selectpicker('refresh');
		        $("#organizationAddModal").modal("show");
	        },
	        error:function(error){
	        	swal(error)
	        }
		});
		   
	});
});

//重置form表单
function resetForm(){
	$(":reset").attr("disabled",false);
	$(":reset").trigger("click");
	$("#organizationId").val(null);
	$("#preOrganization").empty();
}

function formInit(){
    $("#organizationAddForm")[0].reset();
    $("#organizationId").removeAttr("value");
}
