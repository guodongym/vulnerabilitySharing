/**
 * Created by kingsir on 16/7/6.
 *
 * 包含两个ajax请求
 */


window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	//生成修改用户的页面
    	toUpdateUser(row);
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	swal({
    		title:"删除用户",
    		text: "确定删除吗？",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
    		deleteSysUser(row.id);
    	});
    },
    //取消禁用按钮事件
    'click .unforbidden': function (e, value, row, index) {
    	//取消禁用用户
    	cancelDisableSysUser(row.id);
    	
    },
    //禁用按钮事件
    'click .forbidden': function (e, value, row, index) {
    	//禁用用户
    	disableSysUser(row.id);
    },
    //禁用按钮事件
    'click .init': function (e, value, row, index) {
    	//初始化密码
    	initPassword(row.id);
    }
};


//生成修改用户的页面
function toUpdateUser(row){
	//重置添加框
	resetForm();
	//显示"修改用户"
    $("#modalLabel").html("修改用户");
    
    $("#userId").val(row.id);
    $("#userAccount").val(row.userAccount);
    $("#userName").val(row.userName);
    $("#group").val(row.sysUserGroupId);
    $("#organizationId").val(row.id);
    //用户角色
    var sysRoleSet = row.sysRoleSet;
    for(var i=0;i<sysRoleSet.length;i++){
    	//系统管理员
    	 if(sysRoleSet[i].id==1){
             $("#role_admin").attr("checked",true);
         }
    	 //漏洞审核员
    	 if(sysRoleSet[i].id==2){
             $("#role_bug").attr("checked",true);
         }
    	 //任务管理员
    	 if(sysRoleSet[i].id==3){
             $("#role_task").attr("checked",true);
         }
    	 //普通用户
    	 if(sysRoleSet[i].id==4){
              $("#role_user").attr("checked",true);
         }
    }
    $(":reset").attr("disabled",true);
    //用户组
    $.ajax({ 
		 url:CTX+'/sysUserGroup/findSysUserGroups', 
		 type:'post',
		 async: true,
		 dataType:'json',
		 data:{
		 },
		 success:function(data){
			 $("#group").empty();
			 for(var i=0;i<data.length;i++){
			        $("#group").append("<option value='"+data[i].id+"'>"+data[i].userGroupName+"</option>");
			 }
			 $('#group').selectpicker({
			        dropupAuto:true,
			        liveSearch:true,
			        selectOnTab:true,
			        size:10,
			        liveSearchPlaceholder:"请输入关键字搜索"
			 });
			 $("#group").selectpicker('val', row.sysUserGroupId);
			 $("#group").selectpicker('refresh');
			 $("#userAddModal").modal("show");
		 },
		 error:function(error){
		 	swal("错误",error.status,"error");
		 }
	});
	
}




//初始化密码
function initPassword(userId){
	$.post(CTX+'/sysUser/initPassword', {userId:userId}, function(data) {
		if (!data.error) {
			swal('初始化密码成功');
			$('#users_table').bootstrapTable('refresh');
		} 
	});
}



//禁用用户
function disableSysUser(userId){
	$.post(CTX+'/sysUser/disableSysUser', {userId:userId}, function(data) {
		if (!data.error) {
			swal('禁用成功');
			$('#users_table').bootstrapTable('refresh');
		} 
	});
	
}

//取消禁用用户
function cancelDisableSysUser(userId){
	$.post(CTX+'/sysUser/cancelDisableSysUser', {userId:userId}, function(data) {
		if (!data.error) {
			swal('取消禁用成功');
			$('#users_table').bootstrapTable('refresh');
		} 
	});
}


//删除用户
function deleteSysUser(userId){
	$.post(CTX+'/sysUser/delteSysUserById', {userId:userId}, function(data) {
		if (!data.error) {
			swal('删除成功');
			$('#users_table').bootstrapTable('refresh');
		} 
	});
}

var users_table={
	url:CTX+'/sysUser/findPageSysUser',
	pagination: true,
	pageList: [5,10,15,20],//可以选择一页显示 几行
	pageSize:5,//默认一页显示 几行
	pageNumber:1,//默认显示第几页
	sidePagination:'server',//设置为服务器端分页
	search: true,
	showRefresh: true,//刷新按钮
	striped: true,//是否循环变色
	toolbar:"#toolbar",
	   
    columns:[{
        checkbox:true,
        width:"3%"
    },{
        field:"userAccount",
        title:"用户账号",
        width:"10%"
    },{
        field:"userName",
        title:"用户姓名",
        width:"15%"
    },{
        field:"rolesString",
        title:"用户角色",
        width:"27%",
    },{
        field:"sysUserGroupName",
        title:"用户组",
        width:"10%",
    },{
        field:"sysDepartmentName",
        title:"用户单位",
        width:"20%"
    },{
        field:"haddle",
        title: '操作',
        width:"15%",
        align:"center",
        formatter:function(value,row,index){
            var forbidden=null;
            var unforbidden=null;
            if(row.disable){
                forbidden='<i class="glyphicon glyphicon-lock disabled" title="禁用"></i>';
                unforbidden='<a class="unforbidden" href="javascript:void(0)" title="取消禁用">' +
                    '<i class="glyphicon glyphicon-ok-circle"></i></a>';
            }else{
                forbidden='<a class="forbidden" href="javascript:void(0)" title="禁用">' +
                    '<i class="glyphicon glyphicon-lock"></i></a>';
                unforbidden='<i class="glyphicon glyphicon-ok-circle disabled" title="取消禁用"></i>';
            }
            var update='<a class="update" href="javascript:void(0)" title="修改">'+
                '<i class="glyphicon glyphicon-pencil"></i></a>'
            var remove='<a class="remove" href="javascript:void(0)" title="删除">'+
                '<i class="glyphicon glyphicon-trash"></i></a>';
            var init='<a class="init" href="javascript:void(0)" title="初始化密码">'+
                '<i class="glyphicon glyphicon-star-empty"></i></a>';
            return forbidden+""+unforbidden+""+update+""+remove+""+init;
        },
        events:'operateEvents'
    }],
};
$('#users_table').bootstrapTable(users_table);

$(document).ready(function(){
    $("#submit").click(function(){
        var userAccount=$("#userAccount").val();
        if(userAccount.length<1){
            swal("提示", "请输入用户账号", "info");
            return;
        }
//        if(checkAccount(userAccount)){
//            swal("错误!", "账号由字母或数字组成", "error");
//            return;
//        }
        //用户帐号校验
        var testUserAccountStr=/^([a-zA-Z0-9]){4,20}$/;
        if(!testUserAccountStr.test(userAccount)){
            swal("提示", "账号由4到20个字母或数字组成", "info");
            return;
        }       
        var userName=$("#userName").val();
        if(userName.length<1){
            swal("提示", "请输入用户姓名", "info");
            return;
        }
//        if(checkUserName(userName)){
//            swal("错误!", "用户姓名只能为中文", "error");
//            return;
//        }
        //用户名校验
        var testUserNameStr=/^([\u2E80-\u9FFF]){1,20}$/;
        if(!testUserNameStr.test(userName)){
            swal("提示", "用户名由1到20个中文组成", "info");
            return;
        }       
        if(checkChecked()){
            swal("错误!", "请至少选择一个用户角色", "error");
            return;
        }
        //保存用户信息
    	$.post(CTX+'/sysUser/saveOrUpdateSysUer', $("#userAddForm").serialize(), function(data) {
			if (!data.error) {
				swal('保存成功');
				$('#users_table').bootstrapTable('refresh');
				//关闭弹出框
				$('#userAddModal').modal('toggle');
			} else {
				swal(data.message);
			}
		});
    });

    //批量删除操作
    $("#removeUsers").click(function(){
        var selections=$('#users_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要删除的用户", "info");
            return;
        }
        swal({
    		title:"批量删除用户",
    		text: "确定删除这些用户吗?",
    		type: "warning",
    		showCancelButton: true,
    		cancelButtonText:"取消",
    		CancelButtonColor: "#cccccc",
    		confirmButtonText: "确定",
    		closeOnConfirm: true
    	},function(){
            deleteSysUserList(selections);
    	});
    });
    
    //批量删除
    function deleteSysUserList(selections){
 	   var idListString=[];
 	   for(var i=0;i<selections.length;i++){
 		   idListString.push(selections[i].id);
 	   }
 	   $.post(CTX+'/sysUser/deleteSysUserList', 
 			   {idListString:JSON.stringify(idListString)},
 			   function(data) {
 			if (!data.error) {
 				swal('批量删除成功');
 				$('#users_table').bootstrapTable('refresh');
 			}else{
 				swal(data.message);
 			} 
 		});
    }

    //批量禁用操作
    $("#forbidenUsers").click(function(){
        var selections=$('#users_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要禁用的用户", "info");
            return;
        }
        //批量禁用用户
        disableSysUserList(selections);
    });
    
  //批量禁用用户
   function disableSysUserList(selections){
	   var idListString=[];
	   for(var i=0;i<selections.length;i++){
		   idListString.push(selections[i].id);
	   }
	   $.post(CTX+'/sysUser/disableSysUserList', 
			   {idListString:JSON.stringify(idListString)},
			   function(data) {
			if (!data.error) {
				swal('批量禁用成功');
				$('#users_table').bootstrapTable('refresh');
			}else{
				swal(data.message);
			} 
		});
   }
    
    //批量取消禁用操作
    $("#allownUsers").click(function(){
        var selections=$('#users_table').bootstrapTable('getAllSelections');
        if(selections.length<1){
            swal("提示", "请选择要取消禁用的用户", "info");
            return;
        }
        //批量取消禁用
        cancelDisableSysUserList(selections);
    });
});
//批量取消禁用
function cancelDisableSysUserList(selections){
	   var idListString=[];
	   for(var i=0;i<selections.length;i++){
		   idListString.push(selections[i].id);
	   }
	   $.post(CTX+'/sysUser/cancelDisableSysUserList', 
			   {idListString:JSON.stringify(idListString)},
			   function(data) {
			if (!data.error) {
				swal('批量取消禁用成功');
				$('#users_table').bootstrapTable('refresh');
			}else{
				swal(data.message);
			} 
		});
}

//检测是否有勾选用户角色
function checkChecked(){
    if($("#role_user").is(":checked")){
        return false;
    }
    if($("#role_bug").is(":checked")){
        return false;
    }
    if($("#role_task").is(":checked")){
        return false;
    }
    if($("#role_admin").is(":checked")){
        return false;
    }
    return true;
}

////检测用户账号
//function checkAccount(account){
//    if(account.length<3){
//        return true;
//    }
//    var str=/^[a-zA-Z0-9]+$/;
//    return !str.test(account);
//}
//检测用户姓名
function checkUserName(userName){
    var str=/^[\u2E80-\u9FFF]+$/;
    return !str.test(userName);
}

//去添加用户信息
$(function(){
	$("#toAddUser").click(function(){
		//重置form表单
		resetForm();
		//显示"添加用户"
	    $("#modalLabel").html("添加用户");
		$.ajax({ 
			 url:CTX+'/sysUserGroup/findSysUserGroups', 
			 type:'post',
			 async: true,
			 dataType:'json',
			 data:{
			 },
			 success:function(data){
				 if(data.length>=1){
					 $("#group").empty();
					 for(var i=0;i<data.length;i++){
					        $("#group").append("<option value='"+data[i].id+"'>"+data[i].userGroupName+"</option>");
					 }
					 $('#group').selectpicker({
					        dropupAuto:true,
					        liveSearch:true,
					        selectOnTab:true,
					        size:10,
					        liveSearchPlaceholder:"请输入关键字搜索"
					 });
					 $("#group").selectpicker('val', data[0].id);
					 $("#group").selectpicker('refresh');
					 $("#userAddModal").modal("show");
				 }else{
					 swal("还没有用户组，请添加用户组！");
				 }
			 },
			 error:function(error){
			 	swal("错误",error.status,"error");
			 }
		});
		
	});
})


//重置form表单
function resetForm(){
	$("#userId").val(null);//不要删除,删除后点击修改,再点击添加就会出错
	$(":reset").attr("disabled",false);
	$(":reset").trigger("click");
	$(":checkbox").removeAttr("checked");//取消全选 
}
 