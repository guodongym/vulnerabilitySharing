/**
 * Created by kingsir on 16/7/11.
 */

window.operateEvents = {
    //接受队长按钮操作事件
    'click .accept': function (e, value, row, index) {
    	$.post(CTX+'/task/receiveLeader', {taskId : row.taskId}, function(data) {
			if(!data.error){
				swal({
					title:"提示",
					text: "接受队长成功",
					type: "info",
					showCancelButton: false,
					confirmButtonText: "确定",
					closeOnConfirm: true
				},function(){
					$.post(CTX+'/sysMessage/updateRead', {messageId : row.id}, function(data) {
						if(!data.error){
							setNewsNum()
							$('#newsTable').bootstrapTable("refresh")
							$('#newsHistoryTable').bootstrapTable("refresh")
						}else{
							swal(data.message);;
						}
					});
				})
			}else{
				swal(data.message);
			}
		});
    },
    //拒绝队长按钮操作事件
    'click .refuse': function (e, value, row, index) {
    	$.post(CTX+'/task/refuseLeader', {taskId : row.taskId}, function(data) {
			if(!data.error){
				swal({
					title:"提示",
					text: "拒绝接受队长成功",
					type: "info",
					showCancelButton: false,
					confirmButtonText: "确定",
					closeOnConfirm: true
				},function(){
					$.post(CTX+'/sysMessage/updateRead', {messageId : row.id}, function(data) {
						if(!data.error){
							setNewsNum();
							$('#newsTable').bootstrapTable("refresh")
							$('#newsHistoryTable').bootstrapTable("refresh")
						}else{
							swal(data.message);
						}
					});
				})
			}else{
				swal(data.message);
			}
		});
    },
    //查看消息按钮操作事件
    'click .view': function (e, value, row, index) {
    	$.post(CTX+'/sysMessage/updateRead', {messageId : row.id}, function(data) {
    		setNewsNum();
    		if(row.messageType==2){
        		window.location.href = CTX+"/leak/idToLeak?leakId=" + row.leakId;
            }else{
            	window.location.href = CTX+"/task/taskDetail?taskId=" + row.taskId;
            }
    	});
    }
};
$(document).ready(function () {
    var conf={
		method: 'post',
	    contentType: "application/x-www-form-urlencoded",
	    url:CTX+"/sysMessage/findNotReadPage",
		pagination: true,
	    pageList:[5, 10, 15, 20, 25],//可以选择一页显示 几行
		pageSize:5,//默认一页显示 几行
		pageNumber:1,//默认显示第几页
		sidePagination:'server',//设置为服务器端分页
		search: true,
		cache: false,
		showRefresh: true,//刷新按钮
		striped: true,//是否循环变色
	    paginationPreText:"前一页",
	    paginationNextText:"后一页",
	    showToggle:true
    }

    var newsTable=conf;
    newsTable.columns=[{
        field:"message",
        title:"消息内容",
        width:"65%"
    },{
        field:"messageTime",
        title:"消息时间",
        width:"15%",
    },{
        field:"haddle",
        title:"",
        width:"15%",
        align:"center",
        formatter:function (value,row,index) {
            if(row.messageType==1){
                return '<a class="refuse"><i class="glyphicon glyphicon-remove"></i>拒绝</a>'+
                    '<a class="accept"><i class="glyphicon glyphicon-ok"></i>接受</a>'
            }else{
                return '<a class="view"><i class="glyphicon glyphicon-eye-open"></i>查看</a>'
            }
        },
        events:'operateEvents'
    }];
    newsTable.checkboxHeader=true;
    $('#newsTable').bootstrapTable(newsTable);

    
    var historyTable={
		method: 'post',
	    contentType: "application/x-www-form-urlencoded",
	    url:CTX+"/sysMessage/findReadPage",
		pagination: true,
	    pageList:[5, 10, 15, 20, 25],//可以选择一页显示 几行
		pageSize:5,//默认一页显示 几行
		pageNumber:1,//默认显示第几页
		sidePagination:'server',//设置为服务器端分页
		search: true,
		cache: false,
		showRefresh: true,//刷新按钮
		striped: true,//是否循环变色
	    paginationPreText:"前一页",
	    paginationNextText:"后一页",
	    showToggle:true
        };
    historyTable.columns=[{
        field:"message",
        title:"消息内容",
        width:"65%"
    },{
        field:"messageTime",
        title:"消息时间",
        width:"15%",
    },{
        field:"haddle",
        title:"",
        width:"15%",
        align:"center",
        formatter:function (value,row,index) {
            return '<a class="view"><i class="glyphicon glyphicon-eye-open"></i>查看</a>'
        },
        events:'operateEvents'
    }];
    $('#newsHistoryTable').bootstrapTable(historyTable);
});

//重置消息提醒数
function setNewsNum(){
	newsNum-=1;
	$("#newsNum").html(newsNum);
}