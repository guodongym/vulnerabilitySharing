/**
 * Created by kingsir on 16/7/8.
 */
$(document).ready(function(){
	$('#company').selectpicker({
	    dropupAuto:true,
	    liveSearch:true,
	    selectOnTab:true,
	    size:10,
	    liveSearchPlaceholder:"请输入关键字搜索"
	});

    $("#file").fileinput({
        language: 'zh', //设置语言
        uploadUrl: CTX+"/tool/uploadFile", //上传的地址
        allowedFileExtensions :allowFileList,//接收的文件后缀
        autoReplace: true,
        maxFileCount: 1,
        showUpload: true, //是否显示上传按钮
        showCaption: true,//是否显示标题
        browseClass: "btn btn-primary", //按钮样式
        showPreview:false
    });
    
    //下面是头像图片上传成功后的操作，上传成功需要服务器返回图片的url
    var imageFile = "";
    $('#file').on('fileuploaded', function(event, data, previewId, index) {
	    var option={
	        aspectRatio: 1/1,
	        preview:".after_setting",
	        autoCropArea:0.5,
	        touchDragZoom:false
	    }
	    imageFile = data.response.filePath;
	    $('#photoSetting').attr("src",CTX+"/attachment/download/"+data.response.attachmentId);
	    $('#photoSetting').cropper(option);
		$("#cropper").show();
    });

 
    $("#saveInfo").click(function(){
    	var x=0;
    	var y=0;
    	var width = 0;
    	var height = 0;
    	if($('#photoSetting').attr("src")!=undefined){
    		var data=$('#photoSetting').cropper("getData");//获取截取后的图片数据;
    		x= parseInt(data.x)
        	y= parseInt(data.y)
        	width=parseInt(data.width)
        	height=parseInt(data.height)
    	}

    	var userName=$.trim($("#userName").val());
    	if(checkUserName(userName)||checkLength(userName)){
    		swal("提示","用户名称为20字符以内的中文","info");
    		return
    	}
    	var nickName=$.trim($("#userNickName").val());
    	if(checkLength(nickName)){
    		swal("提示","用户昵长度不能超过20字符","info");
    		return
    	}
    	
    	var pass=$("#password").val();
        var repass=$("#repassword").val();
        if(pass.length>pass.replace(/\s+/g, "").length){
            swal("提示","密码不能包含空格","info");
            $("#password").val("");
            $("#password").focus();
            return;
        }
        if(pass!="" && weakPassword(pass)<10){
            swal("提示","检测到弱口令,密码应为不小于6位\n包含字母\数字\字符中的两种的字符串\n不建议使用连续的数字或字母","info");
            $("#password").val("");
            $("#repassword").val("");
            $("#password").focus();
            return;
        }
        if(pass!==repass){
            swal("提示","两次密码不一致","info");
            $("#repassword").val("");
            $("#repassword").focus();
            return;
        }
        var params={
        	id:$("#userId").val(),
        	userName:userName,
        	nickname:nickName,
        	sysDepartmentId:$("#company").val(),
        	password:$("#password").val(),
        	imageFilePath:imageFile,
        	x:x,
        	y:y,
        	width:width,
        	height:height
        };
        
        $.post(CTX+'/sysUser/update', params, function(data) {
    		if (!data.error) {
                swal({
                    title:"提示",
                    text: "保存成功",
                    type: "info",
                    showCancelButton: false,
                    confirmButtonText: "确定",
                    closeOnConfirm: true
                },function(){
                    location.href=CTX+"/toUserSetting?userID="+params.id;
                })
    		} else {
    			swal(data.message);
    		}
    	});
        
    });
});

function checkUserName(userName){
    var str=/^[\u2E80-\u9FFF]+$/;
    return !str.test(userName);
}

function checkLength(str){
	if(str.length>20){
		return true
	}else{
		return false
	}
}

//若口令检测,points<10为弱口令
function weakPassword(pwd) {
    // 基础长度分
    var points = pwd.length;
    var has_letter= new RegExp("[a-z]");
    var has_caps= new RegExp("[A-Z]");
    var has_numbers= new RegExp("[0-9]");
    var has_symbols= new RegExp("\W");
    // 含小写字母加2分
    if(has_letter.test(pwd)){
        points += 2;
    }
    // 含大写字母加2分
    if(has_caps.test(pwd)){
        points += 2;
    }
    // 含数字加2分
    if(has_numbers.test(pwd)){
        points += 2;
    }
    // 含符号加2分
    if(has_symbols.test(pwd)){
        points += 2;
    }
    var n = pwd.match(/(.)11/g)||[];
    points+=2*n.length;
    //顺序字符串
    var consecutive="abcdefghijklmnopqrstuvwxyz0123456789qwertasdfgzxcvb";
    pwd=pwd.toLowerCase();
    for (var i=0;i<consecutive.length-3;i++){
        if (pwd.indexOf(consecutive.substring(i,i+3),0)>-1){
            points -= 2;
        }
    }
    return points;
}