/**
 * Created by kingsir on 16/7/15.
 */

window.operateEvents = {
    //修改按钮操作事件
    'click .update': function (e, value, row, index) {
    	location.href=CTX+"/leak/toUpdateLeak?leakId="+row.id;
    },
    //删除按钮点击事件
    'click .remove': function (e, value, row, index) {
    	deleteLeak(row.id);
    },
    //取消禁用按钮事件
    'click .release': function (e, value, row, index) {
    	releaseLeak(row.id);
    }
};

//发布漏洞信息
function releaseLeak(leakId){
	$.ajax({ 
		 url:CTX+'/leak/releaseLeak', 
		 type:'post',
		 async: true,
		 dataType:'json',
		 data:{
			 leakId:leakId
		 },
		 success:function(data){
			 console.log(data);
			 //如果错误,弹出错误提示
		      if(data.error){
		     	 swal(data.message);
		      }else{
		     	 //错误提示
		          swal("提示", data.message, "info");
		     	 //刷新未发布漏洞列表
		          $('#noReleaseTable').bootstrapTable('refresh');
		          //刷新已发布漏洞列表
		          $('#releaseTable').bootstrapTable('refresh');
		      }
		 },
		 error:function(error){
		 	swal("错误",error.status,"error");
		 }
   });
}




//删除漏洞信息
function deleteLeak(leakId){
	swal({
		title:"删除",
		text: "您确定要删除?",
		type: "warning",
		showCancelButton: true,
		cancelButtonText:"取消",
		CancelButtonColor: "#cccccc",
		confirmButtonText: "确定",
		closeOnConfirm: true
	},function(){
		$.ajax({ 
			 url:CTX+'/leak/realDeleteLeak', 
			 type:'post',
			 async: true,
			 dataType:'json',
			 data:{
				 id:leakId
			 },
			 success:function(data){
				 console.log(data);
				 //如果错误,弹出错误提示
			      if(data.error){
			     	 swal(data.message);
			      }else{
			     	 //错误提示
			          swal("提示", data.message, "info");
			     	 //刷新漏洞列表
			          $('#noReleaseTable').bootstrapTable('refresh');
			      }
			 },
			 error:function(error){
			 	swal("错误",error.status,"error");
			 }
	    });
	});
}


//未发布信息
function unreleaseLeaks(){
	var noReleaseTable={
		url:CTX+'/leak/findMyUnreleasePageLeaks',
		pagination: true,
		pageList: [5,10,15,20],//可以选择一页显示 几行
		pageSize:5,//默认一页显示 几行
		pageNumber:1,//默认显示第几页
		sidePagination:'server',//设置为服务器端分页
		search: true,
		showRefresh: true,//刷新按钮
		striped: true,//是否循环变色
		toolbar:"#toolbar",
		toolbarAlign:"right",
		columns:[{
            field:"submitTime",
            title:"发布时间",
            width:"15%"
        },{
            field:"leakName",
            title:"漏洞标题",
            width:"70%",
            valign:"middle",
            formatter:function(value,row,index){
            	return '<a href="'+CTX+'/leak/idToLeak?leakId='+row.id+'">'+row.leakName+'</a>';
            }
        },{
            field:"haddle",
            title:"操作",
            width:"15%",
            align:"center",
            formatter:function(value,row,index){
                return '<a class="release" href="javascript:void(0)" title="发布"><i class="glyphicon glyphicon-star-empty"></i></a>'+
                    '<a class="update" href="javascript:void(0)" title="修改"><i class="glyphicon glyphicon-pencil"></i></a>'+
                    '<a class="remove" href="javascript:void(0)" title="删除"><i class="glyphicon glyphicon-trash"></i></a>'
            },
            events:'operateEvents'
        }]
	};
	$('#noReleaseTable').bootstrapTable(noReleaseTable);
}




//我的已发布漏洞
function releaseLeaks(){
	var releaseTable={
		url:CTX+'/leak/findMyReleasePageLeaks',
		pagination: true,
		pageList: [5,10,15,20],//可以选择一页显示 几行
		pageSize:5,//默认一页显示 几行
		pageNumber:1,//默认显示第几页
		sidePagination:'server',//设置为服务器端分页
		search: true,
		showRefresh: true,//刷新按钮
		striped: true,//是否循环变色
		toolbar:"#toolbar_releaseTable",
		toolbarAlign:"right",
		columns:[{
			
			field:"submitTime",
            title:"发布时间",
            width:"15%"
        },{
        	field:"leakName",
            title:"漏洞标题",
            width:"60%",
            valign:"middle",
            formatter:function(value,row,index){
            	return '<a href="'+CTX+'/leak/idToLeak?leakId='+row.id+'">'+row.leakName+'</a>';
            }
        },{
            field:"countLeakComment",
            title:"评论数",
            width:"10%",
            align:"center"
        },{
            field:"leakStatus",
            title:"审核状态",
            width:"15%",
            align:"center"
        }]
	};
	$("#releaseTable").bootstrapTable(releaseTable);
}



$(document).ready(function(){
	//我的未发布漏洞
	unreleaseLeaks();
	//我的已发布漏洞
	releaseLeaks();
    //我审核漏洞
	myReviewLeaks();
    //我的已发布漏洞页面的创建漏洞按钮事件
    $("#toolbar_releaseTable>button").click(function(){
        location.href="toNewBug";
    });
});

//我的审核
function myReviewLeaks(){
	var myReviewTable={
			url:CTX+'/leak/pageMyReviewLeaks',
			pagination: true,
			pageList: [5,10,15,20],//可以选择一页显示 几行
			pageSize:5,//默认一页显示 几行
			pageNumber:1,//默认显示第几页
			sidePagination:'server',//设置为服务器端分页
			search: true,
			showRefresh: true,//刷新按钮
			striped: true,//是否循环变色
			columns:[{
	            field:"auditTime",
	            title:"审核时间",
	            width:"15%"
	        },{
	        	field:"leakName",
	            title:"漏洞标题",
	            valign:"middle",
	            width:"65%",
	            formatter:function(value,row,index){
	            	return '<a href="'+CTX+'/leak/idToLeak?leakId='+row.id+'">'+row.leakName+'</a>';
	            }
	        },{
	            field:"leakStatus",
	            title:"审核状态",
	            width:"20%",
	            align:"center"
	        }]
		};
	$("#myReviewTable").bootstrapTable(myReviewTable);
}
//表格配置参数设置
function setTableConf(columns,toolbar){
    var conf={
        columns:columns,
        pagination:true,
        pageNumber:1,
        pageSize:5,
        pageList:[5, 10, 15, 20],
        paginationPreText:"前一页",
        paginationNextText:"后一页",
        search:true,
        toolbar:toolbar,
        search:true,
        toolbarAlign:"right"
    }
    return conf;
}