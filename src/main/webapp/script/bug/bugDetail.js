/**
 * Created by kingsir on 16/7/12.
 */
//加强XSS过滤,需要时使用
//var test1=filterXSS("富文本内容");

$(document).ready(function () {
    //页面加载请求漏洞信息,id获取可从url截取
    var editor= new wangEditor('myComment');
    editor.config.menus=editorMenuConf;
    editor.config.uploadImgUrl=CTX +"/leak/uploadImage";
    editor.config.uploadImgFileName = 'imageFile';
    editor.config.hideLinkImg=true;
    editor.config.menuFixed=true;
    editor.config.printLog = false;
    editor.create();
    //提交评论
	$("#submitComment").click(function(){
		$.post(CTX +'/leakComment/save', {content:editor.$txt.html(),leakId : $("#leakId").val()}, function(data) {
			if (!data.error) {
				editor.$txt.html('<p><br></p>');
				$('#comment_table').bootstrapTable('refresh');
			} else {
				swal(data.message);
			}
		});
	});
});

//渲染评论表格
//传入参数id为漏洞id
function setTable(id){
	var comment_table={
        url:CTX +'/leakComment/findCommentPage?leakId='+$("#leakId").val(),
        pagination: true,
        pageList: [5,10,15,20],//可以选择一页显示 几行
        pageSize:5,//默认一页显示 几行
        pageNumber:1,//默认显示第几页
        sidePagination:'server',//设置为服务器端分页
        striped: true,//是否循环变色
        toolbar:"#toolbar",
        toolbarAlign:"right",
        paginationPreText:"前一页",
        paginationNextText:"后一页",
        showHeader:false,
        cache: false,
        classes:"table table-bordered",
        columns:[{
            width:"10%",
            formatter:function(value,row,index){
                return '<div class="row"><a href="'+CTX+'/toUserInfo?userID='+row.commentUserId+'">\
                <div class="col-xs-12">\
                <img src="'+row.attachmentDownLoadPath+'" style="width: 100%">\
                </div>\
                <div class="col-xs-12 text-center">'+row.commentUserAccount+'</div></a>\
                <div class="col-xs-12 text-center">'+row.commentTime+'</div>\
                </div>';
            }
        },{
            field:"content",
            width:"90%"
        }]
    };
    var table = $('#comment_table').bootstrapTable(comment_table);
}


$(function(){
    //提交审核结果
    $("#reviewSubmit").click(function(){
    	console.log("提交审核结果");
        var result=$("#result").val();
        var opinion=$.trim($("#reviewText").val());
        if(result==0){
        	swal("请选择审核结果");
        	return;
        }
        if(opinion.length<1){
        	swal("请输入审核意见");
        	return;
        }
        //提交审核
        submitAudit();
    });
}) 
//提交审核
function submitAudit(){
	 //添加或修改漏洞信息
	$.post( CTX +'/leak/submitAudit', $("#auditForm").serialize(), function(data) {
		if (!data.error) {
			//关闭弹出框
			$('#reviewModal').modal('toggle');
			//刷新本页面
			location.reload(true) ;
		} else {
			swal(data.message);
		}
	});
}


function getDoc(id){
	location.href=CTX +"/leak/notice?id="+id;
	
}
function updateBug(id){
	//跳转到显示漏洞信息
	location.href=CTX +"/leak/toUpdateLeak?leakId="+id;

}

//加载完成后生成评论
$(function(){
	setTable($("#leakId").val());
});
