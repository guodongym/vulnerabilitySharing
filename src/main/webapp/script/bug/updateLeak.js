/**
 * Created by kingsir on 16/7/12.
 */

//保存漏洞信息 
$(function(){
	 $("#saveLeak").click(function(){
		 //提交表单的校验
		 if(!checkForm(document.getElementById('leakForm'))){
			 return;
		 }
		 var leakForm = $("#leakForm").serialize();
		 $.ajax({ 
			 url:CTX+'/leak/updateLeak', 
			 type:'post',
			 async: true,
			 dataType:'json',
			 data:leakForm,
			 success:function(data){
				 console.log(data);
				 //如果错误,弹出错误提示
			      if(data.error){
			     	 swal(data.message);
			      }else{
			     	 //错误提示
					  swal({
						  title:"提示",
						  text: data.message,
						  type: "info",
						  showCancelButton: false,
						  confirmButtonText: "确定",
						  closeOnConfirm: true
					  },function(){
						  //跳转到所有的漏洞信息列表页面
						  location.href=CTX+"/toMyBug";
					  })
			      }
				 
			 },
			 error:function(error){
			 	swal("错误",error.status,"error");
			 }
	     });
	 });
}) 


//保存并发布漏洞信息 
$(function(){
	 $("#savaReleaseLeak").click(function(){
		 //提交表单的校验
		 if(!checkForm(document.getElementById('leakForm'))){
			 return;
		 }
		 var leakForm = $("#leakForm").serialize();
		 console.log(leakForm);
		 $.ajax({ 
			 url:CTX+'/leak/updateAndReleaseLeak', 
			 type:'post',
			 async: true,
			 dataType:'json',
			 data:leakForm,
			 success:function(data){
				 console.log(data);
				 //如果错误,弹出错误提示
			      if(data.error){
			     	 swal(data.message);
			      }else{
			     	 //错误提示
					  swal({
						  title:"提示",
						  text: data.message,
						  type: "info",
						  showCancelButton: false,
						  confirmButtonText: "确定",
						  closeOnConfirm: true
					  },function(){

						  //跳转到所有的漏洞信息列表页面
						  location.href=CTX+"/toBugList";
					  })
			      }
				 
			 },
			 error:function(error){
			 	swal("错误",error.status,"error");
			 }
	     });
	 });
}) 

$(document).ready(function(){
    var editorConf={
        menus:editorMenuConf,
        uploadImgUrl:CTX+"/leak/uploadImage",
        hideLinkImg: true,
        menuFixed:false,
        uploadHeaders: {
            'Accept' : 'text/x-json'
        }
    }
     
    //漏洞详情 富文本框
    var detail_editor = new wangEditor('detail');
    detail_editor.config.menus=editorConf.menus;
    detail_editor.config.uploadImgUrl=editorConf.uploadImgUrl;
    detail_editor.config.hideLinkImg=editorConf.hideLinkImg;
    detail_editor.config.menuFixed=editorConf.menuFixed;
    detail_editor.config.uploadImgFileName = 'imageFile';
    detail_editor.config.printLog = false;
    detail_editor.create();
    
    
    
    //解决方案的 富文本框
    var repair_editor = new wangEditor('repair');
    repair_editor.config.menus=editorConf.menus;
    repair_editor.config.uploadImgUrl=editorConf.uploadImgUrl;
    repair_editor.config.hideLinkImg=editorConf.hideLinkImg;
    repair_editor.config.menuFixed=editorConf.menuFixed;
    repair_editor.config.uploadImgFileName = 'imageFile';
    repair_editor.config.printLog = false;
    repair_editor.create();
    
    //上传附件
    $("#file").fileinput({
        language: 'zh', //设置语言
        uploadUrl: CTX+"/leak/uploadFile", //上传的地址
        allowedFileExtensions :allowFileList,//接收的文件后缀
        autoReplace: true,
        maxFileCount: 1,
        showUpload: true, //是否显示上传按钮
        showCaption: true,//是否显示标题
        browseClass: "btn btn-primary" //按钮样式
    });
    
    $("#file").on("fileuploaded", function (e, data) {
    	if(data.response.errorUpload){
    		swal(data.response.message)
    	}else{
    		$("#sysAttachmentId").val(data.response.attachmentId);
    	}
    });

});


//刷新漏洞类型和危险等级的select 框
$(function(){
	$("#level").selectpicker('refresh');
	$("#type").selectpicker('refresh');
});
function checkData(){
	 var title=$.trim($("#title").val());
	 if(title.length<1){
		 swal("请输入漏洞名称");
		 return
	 }
	 var system=$.trim($("#system").val());
	 if(system.length<1){
		 swal("请输入涉及的信息系统名称");
		 return
	 }
	 var general=$.trim($("#general").val());
	 if(general.length<1){
		 swal("请输入概要描述");
		 return
	 }
	 var detail=$.trim($("#detail").val());
	 if(detail.length<1){
		 swal("请输入漏洞详情");
		 return
	 }
}




//提交表单的校验
function checkForm(leakForm){
	//1到30个中文/英文/下划线/数字
	var thirtyAnyCharacter=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,30}$/;

	//漏洞标题
    if(!thirtyAnyCharacter.test(leakForm.leakName.value)){
        swal("提示", "漏洞标题为1到30个中文/字母/数字/下划线", "info");
        return false;
    }
    
    //涉及的信息系统名称
    if(!thirtyAnyCharacter.test(leakForm.influenceSystemName.value)){
		  swal("提示", "涉及的信息系统名称为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
    
    //cveId
    if(!thirtyAnyCharacter.test(leakForm.cveId.value)){
    	  swal("提示", "cveId为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
    
    //cnnvdId
    if(!thirtyAnyCharacter.test(leakForm.cnnvdId.value)){
    	  swal("提示", "cnnvdId为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
    
    //cnvdId
    if(!thirtyAnyCharacter.test(leakForm.cnvdId.value)){
    	  swal("提示", "cnvdId为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
  
   
    //概要描述:
    var leakOutlineLength = leakForm.leakOutline.value.length;
    var textMaxLength = 20000;
    if(leakOutlineLength<1||leakOutlineLength>textMaxLength){
    	  swal("提示", "概要描述为1到20000个字符", "info");
	      return false;
    }

    //漏洞详情
    var leakDetailLength = leakForm.leakDetail.value.length;
    if(leakDetailLength<1||leakDetailLength>textMaxLength){
    	  swal("提示", "概要描述为1到20000个字符", "info");
	      return false;
    }
    
    //修复方案:
    var solutionLength = leakForm.solution.value.length;
    if(solutionLength<1||solutionLength>textMaxLength){
    	  swal("提示", "概要描述为1到20000个字符", "info");
	      return false;
    }
    
    return true;
}