/**
 * Created by kingsir on 16/7/26.
 */

$(document).ready(function(){
    setType();
    var editorConf={
        menus:editorMenuConf,
        uploadImgUrl:CTX+"/tool/uploadImage",
        hideLinkImg: true,
        menuFixed:false,
        uploadHeaders: {
            'Accept' : 'text/x-json'
        }
    }
    var detail_editor = new wangEditor('usageMethod');
    detail_editor.config.menus=editorConf.menus;
    detail_editor.config.uploadImgUrl=editorConf.uploadImgUrl;
    detail_editor.config.uploadImgFileName = 'imageFile';
    detail_editor.config.hideLinkImg=editorConf.hideLinkImg;
    detail_editor.config.menuFixed=editorConf.menuFixed;
    detail_editor.config.printLog = false;
    detail_editor.create();

    $("#file").fileinput({
        language: 'zh', //设置语言
        uploadUrl: CTX+"/tool/uploadFile", //上传的地址
        allowedFileExtensions :allowFileList,//接收的文件后缀
        autoReplace: true,
        maxFileCount: 1,
        showUpload: true, //是否显示上传按钮
        showCaption: true,//是否显示标题
        browseClass: "btn btn-primary" //按钮样式
    });
    
    $("#file").on("fileuploaded", function (e, data) {
    	if(data.response.errorUpload){
    		swal(data.response.message)
    	}else{
    		$("#attachmentId").val(data.response.attachmentId);
    	}
    });

    $("#saveTool").click(function(){
    	//提交表单的校验
    	if(!checkForm(document.getElementById('saveToolForm'))){
    		return;
    	}
    	if(dataCheck()){
    		var params = $('#saveToolForm').serialize();
			$.post(CTX+'/tool/save', params, function(data) {
				if (!data.error) {
					swal({
						title:"提示",
						text: "保存成功",
						type: "info",
						showCancelButton: false,
						confirmButtonText: "确定",
						closeOnConfirm: true
					},function(){
						window.location.href=CTX+"/toMyTools";
					})
				} else {
					swal(data.message);
				}
			});
		}
    });
    
    $("#saveAndReleaseTool").click(function(){
    	//提交表单的校验
    	if(!checkForm(document.getElementById('saveToolForm'))){
    		return;
    	}
    	if(dataCheck()){
	    	var params = $('#saveToolForm').serialize();
	    	$.post(CTX+'/tool/saveAndRelease', params, function(data) {
	    		if (!data.error) {
					swal({
						title:"提示",
						text: "保存并发布成功",
						type: "info",
						showCancelButton: false,
						confirmButtonText: "确定",
						closeOnConfirm: true
					},function(){
						window.location.href=CTX+"/toToolList";
					})
	    		} else {
	    			swal(data.message);
	    		}
	    	});
    	}
    });

});
function setType(){
	$.post(CTX+'/toolType/findAll', {}, function(data) {
		for(var i=0;i<data.length;i++){
			$("#type").append("<option value="+ data[i].id +">"+data[i].toolName+"</option>")
		}
		
		$('#type').selectpicker({
	        dropupAuto:true,
	        liveSearch:true,
	        selectOnTab:true,
	        size:10,
	        liveSearchPlaceholder:"请输入关键字搜索",
	        width:"50%"
	    });
	});
	
	
	$.post(CTX+'/leakType/findAll', {}, function(data) {
		for(var i=0;i<data.length;i++){
			$("#bugTypeList").append("<option value="+ data[i].id +">"+data[i].leakName+"</option>")
		}
		
		$('#bugTypeList').selectpicker({
		    dropupAuto:true,
		    liveSearch:true,
		    selectOnTab:true,
		    size:5,
		    liveSearchPlaceholder:"请输入关键字搜索",
		    width:"50%"
		});
	});
	
}




//提交表单的校验
function checkForm(toolForm){
	//1到30个中文/英文/下划线/数字
	var thirtyAnyCharacter=/^([\u2E80-\u9FFF]|[a-zA-Z0-9_]){1,30}$/;

	//工具标题:
    if(!thirtyAnyCharacter.test(toolForm.toolName.value)){
        swal("提示", "工具标题为1到30个中文/字母/数字/下划线", "info");
        return false;
    }
    
    //工具作者:
    if(!thirtyAnyCharacter.test(toolForm.toolAuthor.value)){
		  swal("提示", "工具作者为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
    
    //cveId
    if(!thirtyAnyCharacter.test(toolForm.cveId.value)){
    	  swal("提示", "cveId为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
    
    //cnnvdId
    if(!thirtyAnyCharacter.test(toolForm.cnnvdId.value)){
    	  swal("提示", "cnnvdId为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
    
    //cnvdId
    if(!thirtyAnyCharacter.test(toolForm.cnvdId.value)){
    	  swal("提示", "cnvdId为1到30个中文/字母/数字/下划线", "info");
	      return false;
    }
  
    //数据库允许的最大长度
    var textMaxLength = 20000;
    //工具简介:
    var toolOutlineLength = toolForm.toolOutline.value.length;
    if(toolOutlineLength<1||toolOutlineLength>textMaxLength){
    	  swal("提示", "概要描述为1到20,000个字符", "info");
	      return false;
    }

    //使用说明:
    var usageMethodLength = toolForm.usageMethod.value.length;
    if(usageMethodLength<1||usageMethodLength>textMaxLength){
    	swal("提示", "概要描述为1到20,000个字符", "info");
	    return false;
    }
    
    return true;
}